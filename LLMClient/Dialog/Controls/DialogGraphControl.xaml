<UserControl x:Class="LLMClient.Dialog.Controls.DialogGraphControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:LLMClient.Dialog.Controls"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:dialog="clr-namespace:LLMClient.Dialog"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance local:DialogGraphViewModel}">

    <UserControl.Resources>
        <!-- 颜色资源保留 -->
        <Color x:Key="ForkColor">#f59e0b</Color>
        <SolidColorBrush x:Key="ForkBrush" Color="{StaticResource ForkColor}" />

        <!-- 节点模板：完全自适应高度 -->
        <DataTemplate x:Key="NodeTemplate" DataType="{x:Type local:GraphNodeViewModel}">
            <Grid>
                <!-- 
                   注意：不需要设置具体 Height，只需 Width 
                   Width 绑定到 Panel 外部定义宽度，或写死 260 
                -->
                <Border Width="260" Margin="0,0,0,6"> <!-- 底部留白给 ForkDot -->
                    <materialDesign:Card UniformCornerRadius="12"
                                         Padding="6"
                                         materialDesign:ElevationAssist.Elevation="Dp3"
                                         Style="{StaticResource MaterialDesignOutlinedCard}">
                        <StackPanel>
                            <!-- 角色标签 -->
                            <TextBlock Text="{Binding Data.Role,Mode=OneTime}"
                                       Foreground="{Binding Data.Role,Mode=OneTime,Converter={x:Static dialog:NavigationConverters.RoleToForeground}}"
                                       Style="{StaticResource MaterialDesignSubtitle2TextBlock}"
                                       FontWeight="Bold"
                                       Margin="0,0,0,6" />
                            <TextBlock Text="{Binding Data.DisplayText}"
                                       TextWrapping="Wrap"
                                       MaxHeight="300"
                                       Style="{StaticResource MaterialDesignBody2TextBlock}"
                                       LineHeight="20" />
                        </StackPanel>
                    </materialDesign:Card>
                </Border>

                <!-- Fork Dot -->
                <!-- 垂直对齐到底部，加上 RenderTransform/Margin 修正视觉位置 -->
                <Ellipse Width="12" Height="12"
                         Fill="{StaticResource ForkBrush}"
                         Stroke="White" StrokeThickness="2"
                         HorizontalAlignment="Center"
                         VerticalAlignment="Bottom"
                         Margin="0,0,0,0"
                         Visibility="{Binding ShowForkDot, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Ellipse.Effect>
                        <DropShadowEffect Color="#f59e0b" BlurRadius="4" ShadowDepth="0" Opacity="0.4" />
                    </Ellipse.Effect>
                </Ellipse>
            </Grid>
        </DataTemplate>
    </UserControl.Resources>

    <ScrollViewer PanningMode="Both"
                  HorizontalScrollBarVisibility="Auto"
                  VerticalScrollBarVisibility="Auto">

        <!-- 绑定到扁平化列表 -->
        <ItemsControl ItemsSource="{Binding FlatNodes}"
                      ItemTemplate="{StaticResource NodeTemplate}">
            <!-- 使用自定义面板 -->
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <local:DialogTreePanel ItemWidth="260"
                                           ColumnGap="80"
                                           RowGap="60"
                                           Background="#f8fafc"
                                           IsItemsHost="True" />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>

            <ItemsControl.ItemContainerStyle>
                <Style TargetType="ContentPresenter">
                    <!-- 绑定附加属性 -->
                    <Setter Property="local:GraphProps.NodeId" Value="{Binding Data.Id}" />
                    <Setter Property="local:GraphProps.ParentId" Value="{Binding Data.PreviousItem.Id}" />
                </Style>
            </ItemsControl.ItemContainerStyle>
        </ItemsControl>
    </ScrollViewer>
</UserControl>