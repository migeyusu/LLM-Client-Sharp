<UserControl x:Class="LLMClient.Dialog.Controls.DialogGraphControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:LLMClient.Dialog.Controls"
             mc:Ignorable="d"
             d:DesignHeight="300" d:DesignWidth="300"
             d:DataContext="{d:DesignInstance local:DialogGraphViewModel}">
    <UserControl.Resources>
        <!-- 颜色定义 -->
        <SolidColorBrush x:Key="LineColor">#cbd5e1</SolidColorBrush>
        <SolidColorBrush x:Key="ForkColor">#f59e0b</SolidColorBrush>
        <Color x:Key="UserBorderColor">#2563eb</Color>
        <SolidColorBrush x:Key="BotBgColor">#f1f7ff</SolidColorBrush>
        <SolidColorBrush x:Key="BotBorderColor">#dbeafe</SolidColorBrush>

        <!-- 转换器：Bool To Visibility -->
        <BooleanToVisibilityConverter x:Key="BoolToVis" />

        <!-- 连线的数据模板 -->
        <DataTemplate x:Key="ConnectionTemplate" DataType="{x:Type local:GraphConnectionViewModel}">
            <Path Data="{Binding PathData}"
                  StrokeThickness="2"
                  StrokeStartLineCap="Round"
                  StrokeEndLineCap="Round">
                <Path.Style>
                    <Style TargetType="Path">
                        <!-- 默认为橙色分叉线 -->
                        <Setter Property="Stroke" Value="{StaticResource ForkColor}">
                        </Setter>
                        <!-- 如果是主线，改为灰色 -->
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsMainBranch}" Value="True">
                                <Setter Property="Stroke" Value="{StaticResource LineColor}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Path.Style>
            </Path>
        </DataTemplate>

        <!-- 节点的数据模板 -->
        <DataTemplate x:Key="NodeTemplate" DataType="{x:Type local:GraphNodeViewModel}">
            <Grid Width="{Binding Width}" Height="{Binding Height}">
                <Border CornerRadius="12" BorderThickness="1" Padding="14">
                    <Border.Effect>
                        <DropShadowEffect Color="Black" Opacity="0.05" BlurRadius="12" ShadowDepth="4" Direction="270" />
                    </Border.Effect>
                    <Border.Style>
                        <Style TargetType="Border">
                            <!-- 默认 Bot 样式 -->
                            <Setter Property="Background" Value="White" />
                            <Setter Property="BorderBrush" Value="{StaticResource BotBorderColor}" />
                            <Setter Property="Background" Value="{StaticResource BotBgColor}" />

                            <!-- User 样式触发器 -->
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsUser}" Value="True">
                                    <Setter Property="Background" Value="White" />
                                    <!-- User 左边有蓝条，这里用 Border 左边框模拟 -->
                                    <Setter Property="BorderThickness" Value="4,1,1,1" />
                                    <Setter Property="BorderBrush" Value="#e2e8f0" /> <!-- 默认灰边 -->
                                    <Setter Property="BorderBrush">
                                        <Setter.Value>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                <GradientStop Color="{StaticResource UserBorderColor}" Offset="0" />
                                                <GradientStop Color="{StaticResource UserBorderColor}" Offset="0.02" />
                                                <!-- 模拟左侧边条 -->
                                                <GradientStop Color="#e2e8f0" Offset="0.021" />
                                                <GradientStop Color="#e2e8f0" Offset="1" />
                                            </LinearGradientBrush>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>

                    <StackPanel>
                        <!-- Label -->
                        <TextBlock Text="{Binding Data.Role}"
                                   Foreground="#64748b"
                                   FontSize="11"
                                   FontWeight="Bold"
                                   Margin="0,0,0,6" />
                        <!-- Content -->
                        <TextBlock Text="{Binding Data.DisplayText}"
                                   Foreground="#1e293b"
                                   FontSize="13"
                                   TextWrapping="Wrap"
                                   LineHeight="20" />
                    </StackPanel>
                </Border>

                <!-- Fork Dot (橙色圆点) - 绝对定位在底部中心 -->
                <Ellipse Width="12" Height="12"
                         Fill="{StaticResource ForkColor}"
                         Stroke="White" StrokeThickness="2"
                         HorizontalAlignment="Center" VerticalAlignment="Bottom"
                         Margin="0,0,0,-6"
                         Panel.ZIndex="10"
                         Visibility="{Binding ShowForkDot, Converter={StaticResource BoolToVis}}">
                    <Ellipse.Effect>
                        <DropShadowEffect Color="#f59e0b" BlurRadius="4" ShadowDepth="0" Opacity="0.4" />
                    </Ellipse.Effect>
                </Ellipse>
            </Grid>
        </DataTemplate>

    </UserControl.Resources>

    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" PanningMode="Both">
        <Grid x:Name="CanvasContainer" Width="{Binding ContainerWidth,Mode=OneWay}"
              Height="{Binding ContainerHeight,Mode=OneWay}" Background="#f8fafc">
            <!-- 连线层 (在下) -->
            <ItemsControl ItemsSource="{Binding Connections}"
                          ItemTemplate="{StaticResource ConnectionTemplate}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas IsItemsHost="True" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
            </ItemsControl>

            <!-- 节点层 (在上) -->
            <ItemsControl ItemsSource="{Binding Nodes}"
                          ItemTemplate="{StaticResource NodeTemplate}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas IsItemsHost="True" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemContainerStyle>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="Canvas.Left" Value="{Binding X}" />
                        <Setter Property="Canvas.Top" Value="{Binding Y}" />
                    </Style>
                </ItemsControl.ItemContainerStyle>
            </ItemsControl>
        </Grid>
    </ScrollViewer>
</UserControl>