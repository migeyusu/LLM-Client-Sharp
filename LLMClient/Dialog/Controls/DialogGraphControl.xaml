<UserControl x:Class="LLMClient.Dialog.Controls.DialogGraphControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:LLMClient.Dialog.Controls"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:dialog="clr-namespace:LLMClient.Dialog"
             xmlns:component="clr-namespace:LLMClient.Component"
             xmlns:b="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:models="clr-namespace:LLMClient.Dialog.Models"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance local:DialogGraphViewModel}">
    <UserControl.Resources>
        <Color x:Key="ForkColor">#f59e0b</Color>
        <SolidColorBrush x:Key="ForkBrush" Color="{StaticResource ForkColor}" />
        <Style TargetType="{x:Type materialDesign:Card}"
               BasedOn="{StaticResource MaterialDesignOutlinedCard}">
            <Setter Property="BorderThickness"
                    Value="0" />
            <Setter Property="BorderBrush"
                    Value="{Binding Role,Mode=OneTime,Converter={x:Static dialog:NavigationConverters.RoleToBorderBrush}}" />
            <Setter Property="Padding"
                    Value="10" />
            <Setter Property="UniformCornerRadius"
                    Value="12" />
            <Style.Triggers>
                <DataTrigger
                    Binding="{Binding  RelativeSource={RelativeSource FindAncestor, AncestorType=ListBoxItem},Path=IsSelected}"
                    Value="True">
                    <Setter Property="BorderThickness" Value="3" />
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <DataTemplate x:Key="NodeTemplate" DataType="{x:Type local:GraphNodeViewModel}">
            <Grid ClipToBounds="False">
                <ContentPresenter Content="{Binding Data,Mode=OneTime}">
                    <ContentPresenter.ContentTemplateSelector>
                        <component:TypeBasedDataTemplateSelector>
                            <component:DataTemplateTypePair>
                                <DataTemplate DataType="{x:Type models:RequestViewItem}">
                                    <materialDesign:Card>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition />
                                            </Grid.RowDefinitions>
                                            <Button Style="{StaticResource ItemDeleteButtonStyle}"
                                                    Command="Delete" 
                                                    CommandParameter="{Binding}"/>
                                            <TextBlock Grid.Row="0"
                                                       Text="{Binding Role,Mode=OneTime}"
                                                       HorizontalAlignment="Left"
                                                       Foreground="{Binding Role,Mode=OneTime,Converter={x:Static dialog:NavigationConverters.RoleToForeground}}"
                                                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                                       FontWeight="Bold"
                                                       Margin="0,0,0,10" />
                                            <TextBlock Grid.Row="1"
                                                       Text="{Binding TextMessage,Mode=OneWay}"
                                                       TextWrapping="Wrap"
                                                       MaxHeight="300"
                                                       Style="{StaticResource MaterialDesignBody2TextBlock}"
                                                       LineHeight="20" />
                                        </Grid>
                                    </materialDesign:Card>
                                </DataTemplate>
                            </component:DataTemplateTypePair>
                            <component:DataTemplateTypePair>
                                <DataTemplate DataType="{x:Type models:MultiResponseViewItem}">
                                    <materialDesign:Card>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition />
                                            </Grid.RowDefinitions>
                                            <TextBlock Text="{Binding Role,Mode=OneTime}"
                                                       HorizontalAlignment="Left"
                                                       Foreground="{Binding Role,Mode=OneTime,Converter={x:Static dialog:NavigationConverters.RoleToForeground}}"
                                                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                                       FontWeight="Bold"
                                                       Margin="0,0,0,10" />
                                            <TextBlock Grid.Row="1"
                                                       Text="{Binding AcceptedResponse.TextContent,Mode=OneTime}"
                                                       TextWrapping="Wrap"
                                                       MaxHeight="300"
                                                       Style="{StaticResource MaterialDesignBody2TextBlock}"
                                                       LineHeight="20" />
                                            <materialDesign:PopupBox HorizontalAlignment="Right"
                                                                     Grid.Row="0"
                                                                     VerticalAlignment="Center"
                                                                     ToggleContent="{materialDesign:PackIcon Kind=InfoBox}"
                                                                     PopupUniformCornerRadius="8"
                                                                     PlacementMode="LeftAndAlignMiddles">
                                                <ScrollViewer MaxHeight="600"
                                                              MaxWidth="600">
                                                    <TextBlock TextWrapping="Wrap"
                                                               Style="{StaticResource MaterialDesignBody2TextBlock}"
                                                               Margin="16"
                                                               Text="{Binding AcceptedResponse.TextContent,Mode=OneTime}" />
                                                </ScrollViewer>
                                            </materialDesign:PopupBox>
                                        </Grid>
                                    </materialDesign:Card>
                                </DataTemplate>
                            </component:DataTemplateTypePair>
                            <component:DataTemplateTypePair>
                                <DataTemplate DataType="{x:Type models:EraseViewItem}">
                                    <materialDesign:PackIcon Kind="ScissorsCutting"
                                                             VerticalAlignment="Center"
                                                             HorizontalAlignment="Center"
                                                             Width="50"
                                                             Height="50"
                                                             ToolTip="Cutting Context" />
                                </DataTemplate>
                            </component:DataTemplateTypePair>
                        </component:TypeBasedDataTemplateSelector>
                    </ContentPresenter.ContentTemplateSelector>
                </ContentPresenter>
                <!-- Fork Dot -->
                <!-- 垂直对齐到底部，加上 RenderTransform/Margin 修正视觉位置 -->
                <Ellipse Width="12"
                         Height="12"
                         Fill="{StaticResource ForkBrush}"
                         Stroke="White" StrokeThickness="2"
                         HorizontalAlignment="Center"
                         VerticalAlignment="Bottom"
                         Margin="0,0,0,0"
                         Visibility="{Binding ShowForkDot, Converter={StaticResource BooleanToVisibilityConverter},Mode=OneTime}">
                    <Ellipse.Effect>
                        <DropShadowEffect Color="#f59e0b" BlurRadius="4" ShadowDepth="0" Opacity="0.4" />
                    </Ellipse.Effect>
                </Ellipse>
            </Grid>
        </DataTemplate>
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <ScrollViewer PanningMode="Both"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto">
            <!-- 绑定到扁平化列表 -->
            <ListBox ItemsSource="{Binding FlatNodes,Mode=OneWay}"
                     ItemTemplate="{StaticResource NodeTemplate}"
                     MouseDoubleClick="Control_OnMouseDoubleClick"
                     SelectedItem="{Binding SelectedLeaf,Mode=TwoWay}">
                <ListBox.LayoutTransform>
                    <ScaleTransform ScaleX="{Binding Value, ElementName=ZoomSlider}"
                                    ScaleY="{Binding Value, ElementName=ZoomSlider}" />
                </ListBox.LayoutTransform>
                <!-- 使用自定义面板 -->
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <local:DialogTreePanel ItemWidth="300"
                                               ColumnGap="80"
                                               RowGap="60"
                                               Background="{DynamicResource MaterialDesign.Brush.Background}"
                                               IsItemsHost="True" />
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
                <ListBox.ItemContainerStyle>
                    <Style TargetType="{x:Type ListBoxItem}"
                           BasedOn="{StaticResource {x:Type ListBoxItem}}">
                        <Setter Property="HorizontalContentAlignment"
                                Value="Stretch" />
                        <!-- 绑定附加属性 -->
                        <Setter Property="local:GraphProps.NodeId" Value="{Binding Data.Id,Mode=OneTime}" />
                        <Setter Property="local:GraphProps.ParentId"
                                Value="{Binding Data.PreviousItem.Id,Mode=OneTime}" />
                        <Setter Property="Padding"
                                Value="0" />
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="{x:Type ListBoxItem}">
                                    <Grid Margin="{TemplateBinding Margin}"
                                          Background="{TemplateBinding Background}"
                                          ClipToBounds="False">
                                        <ContentPresenter x:Name="Ripple"
                                                          Margin="{TemplateBinding Padding}"
                                                          HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                          VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                          Content="{TemplateBinding Content}"
                                                          ContentTemplate="{TemplateBinding ContentTemplate}"
                                                          ContentTemplateSelector="{TemplateBinding ContentTemplateSelector}"
                                                          Focusable="False"
                                                          ClipToBounds="False"
                                                          SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" />
                                        <materialDesign:PackIcon Kind="HandPointingLeft"
                                                                 Width="35"
                                                                 Height="35"
                                                                 x:Name="Icon"
                                                                 Visibility="Collapsed"
                                                                 HorizontalAlignment="Right"
                                                                 VerticalAlignment="Center"
                                                                 Margin="0,0,-35,0" />
                                    </Grid>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="Ripple" Property="Opacity" Value=".92" />
                                            <Setter TargetName="Icon"
                                                    Property="Visibility"
                                                    Value="Visible" />
                                        </Trigger>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Opacity" Value=".56" />
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="VerticalContentAlignment"
                                Value="{Binding VerticalContentAlignment, RelativeSource={RelativeSource AncestorType={x:Type ItemsControl}}, FallbackValue=Center}" />
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.CommandBindings>
                    <CommandBinding Command="Delete"
                                    Executed="Delete_CommandBinding_OnExecuted" />
                </ListBox.CommandBindings>
            </ListBox>
        </ScrollViewer>
        <Border Grid.Row="0" VerticalAlignment="Top" HorizontalAlignment="Right"
                Background="{DynamicResource MaterialDesignPaper}"
                CornerRadius="8" Padding="4" Margin="16"
                Effect="{DynamicResource MaterialDesignShadowDepth2}">
            <StackPanel Orientation="Horizontal">
                <Button Style="{StaticResource MaterialDesignIconButton}" Click="ZoomOut_Click" ToolTip="缩小">
                    <materialDesign:PackIcon Kind="Minus" />
                </Button>

                <Slider x:Name="ZoomSlider" Width="60" Minimum="0.2" Maximum="3.0" Value="1.0"
                        VerticalAlignment="Center" Margin="4,0"
                        Ticks="0.2, 0.5, 1.0, 1.5, 2.0, 3.0" IsSnapToTickEnabled="False" />

                <Button Style="{StaticResource MaterialDesignIconButton}" Click="ZoomIn_Click" ToolTip="放大">
                    <materialDesign:PackIcon Kind="Plus" />
                </Button>
                <Button Style="{StaticResource MaterialDesignFlatButton}" Click="ZoomReset_Click" ToolTip="重置缩放"
                        Padding="4,0" MinWidth="50" Foreground="{DynamicResource MaterialDesignBody}">
                    <TextBlock Text="{Binding Value, ElementName=ZoomSlider, StringFormat={}{0:P0}}" />
                </Button>
            </StackPanel>
        </Border>
        <Button Grid.Row="1"
                HorizontalAlignment="Right"
                Content="Select As Current Leaf"
                Margin="16,6"
                IsEnabled="{Binding CanSelect,Mode=OneWay}"
                Command="{Binding SelectCommand}" />
    </Grid>

</UserControl>