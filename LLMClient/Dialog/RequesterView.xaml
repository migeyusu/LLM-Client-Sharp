<UserControl x:Class="LLMClient.Dialog.RequesterView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:abstraction="clr-namespace:LLMClient.Abstraction"
             xmlns:local="clr-namespace:LLMClient.Dialog"
             xmlns:rag="clr-namespace:LLMClient.Rag"
             xmlns:toolCall="clr-namespace:LLMClient.ToolCall"
             xmlns:converters="clr-namespace:LLMClient.Component.Converters"
             xmlns:viewModel="clr-namespace:LLMClient.Component.ViewModel"
             xmlns:component="clr-namespace:LLMClient.Component"
             xmlns:customControl="clr-namespace:LLMClient.Component.CustomControl"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance local:RequesterViewModel}"
             d:DesignHeight="110" d:DesignWidth="1600"
             AllowDrop="True">
    <UserControl.Resources>
        <KeyBinding x:Key="PromptKeyBinding"
                    Key="Enter"
                    Command="{Binding NewRequestCommand}" />
    </UserControl.Resources>
    <Border CornerRadius="8"
            ClipToBounds="True"
            AllowDrop="True"
            DragEnter="PromptTextBox_OnDragEnter"
            DragLeave="UIElement_OnDragLeave"
            Drop="PromptTextBox_OnDrop"
            Background="{DynamicResource MaterialDesign.Brush.Card.Background}"
            BorderThickness="1.5">
        <Border.Style>
            <Style TargetType="{x:Type Border}">
                <Setter Property="BorderBrush"
                        Value="{DynamicResource MaterialDesign.Brush.TextBox.Border}" />
                <Style.Triggers>
                    <DataTrigger Binding="{Binding ElementName=PromptTextBox,Path=IsFocused,Mode=OneWay}"
                                 Value="True">
                        <DataTrigger.Setters>
                            <Setter Property="BorderBrush"
                                    Value="{DynamicResource MaterialDesign.Brush.Primary.Light}" />
                        </DataTrigger.Setters>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>
        <StackPanel Orientation="Vertical">
            <TextBox x:Name="PromptTextBox"
                     Margin="8"
                     materialDesign:HintAssist.Hint="输入Prompt"
                     materialDesign:HintAssist.HintHorizontalAlignment="Left"
                     AllowDrop="True"
                     AcceptsReturn="True"
                     AcceptsTab="True"
                     VerticalAlignment="Stretch"
                     HorizontalAlignment="Stretch"
                     MinHeight="40"
                     Background="Transparent"
                     BorderThickness="0"
                     Text="{Binding  PromptString,Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}"
                     TextWrapping="Wrap"
                     VerticalScrollBarVisibility="Auto">
                <TextBox.CommandBindings>
                    <CommandBinding Command="ApplicationCommands.Paste"
                                    Executed="PasteCommandBinding_OnExecuted" />
                </TextBox.CommandBindings>
                <TextBox.Style>
                    <Style TargetType="TextBox"
                           BasedOn="{StaticResource MaterialDesignTextBoxBase}">
                        <Setter Property="materialDesign:TextFieldAssist.DecorationVisibility"
                                Value="Collapsed" />
                        <Setter Property="MaxHeight" Value="40" />
                        <Style.Triggers>
                            <Trigger Property="IsKeyboardFocusWithin" Value="True">
                                <Setter Property="MaxHeight" Value="500" />
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </TextBox.Style>
            </TextBox>
            <Border Background="{DynamicResource MaterialDesignTextFieldBoxBackground}">
                <StackPanel Margin="8,0">
                    <ScrollViewer Style="{StaticResource HorizontalArrowScrollViewer}"
                                  Visibility="{Binding  Attachments.Count,Converter={x:Static converters:SnapConverters.CountToVisibilityConverter}}">
                        <ItemsControl Padding="0,5,0,0"
                                      ItemsSource="{Binding Attachments,Mode=OneWay}"
                                      ItemsPanel="{StaticResource HorizontalItemsPanelTemplate}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="{x:Type local:Attachment}">
                                    <materialDesign:Chip IsDeletable="True"
                                                         MaxWidth="160"
                                                         Margin="0,0,5,0"
                                                         IconBackground="{DynamicResource MaterialDesign.Brush.Secondary.Light}"
                                                         IconForeground="{DynamicResource MaterialDesign.Brush.Secondary.Light.Foreground}"
                                                         ToolTipService.InitialShowDelay="0"
                                                         ToolTip="{Binding OriUri,Mode=OneTime}"
                                                         Command="{Binding OpenFileCommand}"
                                                         CommandParameter="{Binding}"
                                                         Content="{Binding Name,Mode=OneTime}"
                                                         DeleteCommand="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType=ItemsControl},Path=DataContext.RemoveAttachmentCommand}"
                                                         DeleteCommandParameter="{Binding  }">
                                        <materialDesign:Chip.Icon>
                                            <materialDesign:PackIcon Width="18"
                                                                     Height="18"
                                                                     Foreground="{DynamicResource MaterialDesign.Brush.Secondary.Light.Foreground}"
                                                                     Kind="{Binding Type,Mode=OneWay,Converter={x:Static converters:AttachmentTypeConverter.Instance}}" />
                                        </materialDesign:Chip.Icon>
                                    </materialDesign:Chip>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                    <Grid Margin="0,5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0"
                                    Orientation="Horizontal">
                            <materialDesign:Card Padding="8,0"
                                                 UniformCornerRadius="12"
                                                 Height="32"
                                                 materialDesign:ElevationAssist.Elevation="Dp3">
                                <CheckBox materialDesign:CheckBoxAssist.CheckBoxSize="20"
                                          DataContext="{Binding FunctionTreeSelector,Mode=OneWay}"
                                          IsChecked="{Binding FunctionSelected,Mode=TwoWay}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Tools"
                                                   VerticalAlignment="Center" />
                                        <ComboBox Width="80"
                                                  ToolTip="When only model don't support function call, only 'Prompt' mode is enable."
                                                  ToolTipService.InitialShowDelay="0"
                                                  BorderThickness="0"
                                                  materialDesign:HintAssist.Hint="Mode"
                                                  Padding="6,3"
                                                  VerticalAlignment="Center"
                                                  ItemsSource="{Binding SelectableCallEngineTypes,Mode=OneWay}"
                                                  SelectedItem="{Binding EngineType,Mode=TwoWay}">
                                        </ComboBox>
                                        <materialDesign:PopupBox Margin="4,0,6,0"
                                                                 StaysOpen="True"
                                                                 PlacementMode="TopAndAlignLeftEdges"
                                                                 PopupUniformCornerRadius="8"
                                                                 Opened="McpPopupBox_OnOpened"
                                                                 ToggleContent="{materialDesign:PackIcon Kind=Tools,Size=16}"
                                                                 VerticalAlignment="Center"
                                                                 ToolTip="Function Call工具"
                                                                 PopupContent="{Binding Mode=OneWay}"
                                                                 PopupContentTemplate="{StaticResource FunctionTreeDataTemplate}"
                                                                 Style="{StaticResource MaterialDesignToolPopupBox}" />
                                    </StackPanel>
                                </CheckBox>
                            </materialDesign:Card>
                            <materialDesign:Card Padding="8,0"
                                                 Margin="6,0,0,0"
                                                 UniformCornerRadius="12"
                                                 Height="32"
                                                 Visibility="{Binding SearchConfig.IsSearchAvailable,Mode=OneWay,Converter={StaticResource BooleanToVisibilityConverter}}"
                                                 materialDesign:ElevationAssist.Elevation="Dp3">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PopupBox StaysOpen="True"
                                                             PlacementMode="TopAndAlignLeftEdges"
                                                             ToggleContent="{materialDesign:PackIcon Kind=Web,Size=16}"
                                                             VerticalAlignment="Center"
                                                             ToolTip="Web Search工具"
                                                             PopupUniformCornerRadius="8"
                                                             PopupContent="{Binding SearchConfig,Mode=OneWay}"
                                                             Style="{StaticResource MaterialDesignToolPopupBox}">
                                        <materialDesign:PopupBox.PopupContentTemplate>
                                            <DataTemplate DataType="{x:Type toolCall:SearchConfigViewModel}">
                                                <ListBox ItemsSource="{Binding SelectableSearchOptions,Mode=OneWay}"
                                                         SelectedItem="{Binding SelectedSearchService,Mode=TwoWay}"
                                                         SelectionMode="Single">
                                                    <ListBox.ItemTemplate>
                                                        <DataTemplate DataType="{x:Type abstraction:ISearchOption}">
                                                            <StackPanel Orientation="Horizontal">
                                                                <Image
                                                                    Source="{Binding Icon.CurrentSource,Mode=OneWay}"
                                                                    Width="21"
                                                                    Height="21" />
                                                                <TextBlock Text="{Binding Name,Mode=OneTime}"
                                                                           VerticalAlignment="Center"
                                                                           Margin="6,0,0,0" />
                                                            </StackPanel>
                                                        </DataTemplate>
                                                    </ListBox.ItemTemplate>
                                                </ListBox>
                                            </DataTemplate>
                                        </materialDesign:PopupBox.PopupContentTemplate>
                                    </materialDesign:PopupBox>
                                    <TextBlock Text="Search"
                                               Margin="6,0"
                                               VerticalAlignment="Center" />
                                    <ToggleButton IsChecked="{Binding SearchConfig.SearchEnable,Mode=TwoWay}" />
                                </StackPanel>
                            </materialDesign:Card>
                            <materialDesign:Card Padding="6,0"
                                                 Margin="6,0,0,0"
                                                 UniformCornerRadius="12"
                                                 Height="32"
                                                 Visibility="{Binding SearchConfig.IsSearchAvailable,Mode=OneWay,Converter={StaticResource BooleanToVisibilityConverter}}"
                                                 materialDesign:ElevationAssist.Elevation="Dp3">
                                <StackPanel Orientation="Horizontal"
                                            Margin="10,0,0,0">
                                    <Ellipse Width="5"
                                             Height="5"
                                             VerticalAlignment="Center"
                                             Margin="0,0,8,0">
                                        <Ellipse.Style>
                                            <Style TargetType="{x:Type Ellipse}">
                                                <Setter Property="Fill"
                                                        Value="Gray" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsRagEnabled,Mode=OneWay}"
                                                                 Value="True">
                                                        <Setter Property="Fill"
                                                                Value="ForestGreen" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Ellipse.Style>
                                    </Ellipse>
                                    <TextBlock Text="RAG"
                                               VerticalAlignment="Center" />
                                    <materialDesign:PopupBox Margin="6,0"
                                                             StaysOpen="True"
                                                             PopupMode="Click"
                                                             Opened="RagPopupBox_OnOpened"
                                                             Closed="RagPopupBox_OnClosed"
                                                             PlacementMode="TopAndAlignLeftEdges"
                                                             ToggleContent="{materialDesign:PackIcon Kind=DataMatrixEdit,Size=16}"
                                                             ToggleCheckedContent="{materialDesign:PackIcon Kind=Add,Size=16}"
                                                             VerticalAlignment="Center"
                                                             PopupUniformCornerRadius="8"
                                                             ToolTip="RAG Resource As Tools"
                                                             PopupContent="{Binding }"
                                                             Style="{StaticResource MaterialDesignToolPopupBox}">
                                        <materialDesign:PopupBox.PopupContentTemplate>
                                            <DataTemplate DataType="{x:Type local:RequesterViewModel}">
                                                <ItemsControl ItemsSource="{Binding RagSources,Mode=OneWay}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate
                                                            DataType="{x:Type  viewModel:SelectableViewModel`1[]}">
                                                            <StackPanel Orientation="Horizontal">
                                                                <CheckBox IsChecked="{Binding IsSelected,Mode=TwoWay}"
                                                                          materialDesign:CheckBoxAssist.CheckBoxSize="20"
                                                                          IsEnabled="{Binding   Data.Status,Mode=OneWay,Converter={x:Static converters:SnapConverters.RagFileStatusToBoolConverter}}"
                                                                          Content="{Binding Data,Mode=OneTime}">
                                                                    <CheckBox.ContentTemplateSelector>
                                                                        <component:TypeBasedDataTemplateSelector>
                                                                            <component:DataTemplateTypePair>
                                                                                <DataTemplate
                                                                                    DataType="{x:Type rag:RagFileBase}">
                                                                                    <StackPanel
                                                                                        Orientation="Horizontal">
                                                                                        <Image Width="30"
                                                                                            Height="30"
                                                                                            VerticalAlignment="Center"
                                                                                            Source="{Binding FileType,Mode=OneTime,Converter={x:Static converters:SnapConverters.DocumentTypeToImageConverter}}" />
                                                                                        <TextBlock MaxWidth="200"
                                                                                            TextTrimming="CharacterEllipsis"
                                                                                            Text="{Binding ResourceName,Mode=OneTime}"
                                                                                            TextWrapping="Wrap"
                                                                                            Margin="6,0"
                                                                                            VerticalAlignment="Center" />
                                                                                    </StackPanel>
                                                                                </DataTemplate>
                                                                            </component:DataTemplateTypePair>
                                                                        </component:TypeBasedDataTemplateSelector>
                                                                    </CheckBox.ContentTemplateSelector>
                                                                </CheckBox>
                                                            </StackPanel>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </DataTemplate>
                                        </materialDesign:PopupBox.PopupContentTemplate>
                                    </materialDesign:PopupBox>
                                </StackPanel>
                            </materialDesign:Card>
                            <Button Style="{StaticResource MaterialDesignFloatingActionMiniButton}"
                                    Command="{Binding AddImageCommand}"
                                    VerticalAlignment="Center" Margin="10,0,0,0"
                                    Height="32"
                                    Width="32"
                                    Content="{materialDesign:PackIcon Kind=ImagePlus,Size=20}"
                                    Visibility="{Binding DefaultClient.Model.SupportImageInput,Mode=OneWay,Converter={StaticResource BooleanToVisibilityConverter}}" />
                            <Button Style="{StaticResource MaterialDesignFloatingActionMiniButton}"
                                    Height="32"
                                    Width="32"
                                    Content="{materialDesign:PackIcon Kind=FileSearch,Size=20}"
                                    VerticalAlignment="Center" Margin="10,0,0,0"
                                    Command="{x:Static materialDesign:DialogHost.OpenDialogCommand}"
                                    CommandParameter="{Binding QueryViewModel,Mode=OneTime}" />
                        </StackPanel>
                        <StackPanel Grid.Column="2"
                                    Orientation="Horizontal"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Bottom">
                            <customControl:ModelButton VerticalAlignment="Center"
                                                       Command="{x:Static materialDesign:DialogHost.OpenDialogCommand}"
                                                       CommandParameter="{Binding DefaultClient,Mode=OneWay}"
                                                       ChangeModelEnable="True"
                                                       ChangeModelCommand="{Binding ChangeModelCommand}"
                                                       ModelDetailCommand="{x:Static materialDesign:DialogHost.OpenDialogCommand}"
                                                       Model="{Binding DefaultClient.Model,Mode=OneWay}" />
                            <CheckBox Content="回车发送"
                                      Margin="10,0,0,0"
                                      Checked="EnterKeyInputBinding_OnChecked"
                                      Padding="0,0,0,0"
                                      Height="36"
                                      Unchecked="EnterKeyInputBinding_OnUnchecked"
                                      materialDesign:CheckBoxAssist.CheckBoxSize="30" />
                            <!--<Button Width="120"
                                    Height="30"
                                    Content="安全黏贴"
                                    Click="TestPaste_OnClick"/>-->
                            <Button Command="{Binding NewRequestCommand}"
                                    IsEnabled="{Binding DefaultClient.IsResponding,Converter={StaticResource InvertBooleanConverter}}"
                                    Width="80"
                                    Height="30"
                                    Margin="16,0,0,0"
                                    Style="{StaticResource MaterialDesignRaisedDarkButton}">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="发送"
                                               VerticalAlignment="Center" />
                                    <materialDesign:PackIcon Kind="Send"
                                                             Width="16"
                                                             Height="16"
                                                             Margin="6,0,0,0"
                                                             VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                            <Button Command="{Binding SummarizeCommand}"
                                    Margin="16,0,0,0"
                                    Width="80"
                                    Style="{StaticResource MaterialDesignPaperLightButton}">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="总结"
                                               VerticalAlignment="Center" />
                                    <materialDesign:PackIcon Kind="LightbulbOnOutline"
                                                             Width="16"
                                                             Height="16"
                                                             Margin="6,0,0,0"
                                                             VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                            <!--<Button Command="{Binding TestCommand}"
                        Content="测试" />-->
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>
        </StackPanel>
    </Border>
</UserControl>