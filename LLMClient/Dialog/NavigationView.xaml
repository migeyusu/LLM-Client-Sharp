<UserControl x:Class="LLMClient.Dialog.NavigationView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:LLMClient.Dialog"
             xmlns:converters="clr-namespace:LLMClient.Component.Converters"
             mc:Ignorable="d"
             d:DesignHeight="300" d:DesignWidth="300"
             d:DataContext="{d:DesignInstance local:INavigationViewModel}">
    <UserControl.Resources>
        <!-- 分支颜色定义 -->
        <Style x:Key="ChatTreeViewItemStyle" TargetType="TreeViewItem">
            <Setter Property="IsExpanded" Value="True" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TreeViewItem"
                                     d:DataContext="{d:DesignInstance local:BaseDialogItem}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <!-- ====== 第一行：当前节点 ====== -->
                            <Grid Grid.Row="0" Margin="0,0,0,0">
                                <Grid.ColumnDefinitions>
                                    <!-- 连线区域（扩大以容纳分叉） -->
                                    <ColumnDefinition Width="48" />
                                    <!-- 内容区域 -->
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <!-- 连线Canvas -->
                                <Canvas Grid.Column="0"
                                        Width="48"
                                        ClipToBounds="False"
                                        VerticalAlignment="Stretch"
                                        MinHeight="40">

                                    <!-- 节点圆点（普通节点） -->
                                    <Ellipse x:Name="NodeDot"
                                             Canvas.Left="18" Canvas.Top="14"
                                             Width="12" Height="12"
                                             Fill="{Binding Role, Converter={x:Static local:NavigationConverters.RoleToBorder},Mode=OneTime}"
                                             Stroke="White"
                                             StrokeThickness="2.5" />

                                    <!-- 分叉节点特殊标记 -->
                                    <Grid x:Name="ForkMarker"
                                          Canvas.Left="12" Canvas.Top="8"
                                          Width="24" Height="24"
                                          Visibility="Collapsed">
                                        <Ellipse Fill="White"
                                                 Stroke="#FF9500"
                                                 StrokeThickness="3" />
                                        <Path Data="M8,12 L12,16 L16,12 M12,8 L12,16"
                                              Stroke="#FF9500"
                                              StrokeThickness="2.5"
                                              StrokeStartLineCap="Round"
                                              StrokeEndLineCap="Round"
                                              StrokeLineJoin="Round" />
                                    </Grid>
                                </Canvas>

                                <!-- 节点内容卡片 -->
                                <Border Grid.Column="1"
                                        Margin="4,4,8,4"
                                        Padding="12,8"
                                        CornerRadius="8"
                                        Background="{Binding Role, Converter={x:Static local:NavigationConverters.RoleToBackground},Mode=OneTime}"
                                        BorderBrush="{Binding Role, Converter={x:Static local:NavigationConverters.RoleToBorder},Mode=OneTime}"
                                        BorderThickness="1.5"
                                        Cursor="Hand"
                                        MaxWidth="600"
                                        HorizontalAlignment="Left">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="8"
                                                          ShadowDepth="2"
                                                          Opacity="0.2"
                                                          Color="Black" />
                                    </Border.Effect>

                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <!-- 角色标签 + 分叉标记 -->
                                        <StackPanel Grid.Row="0"
                                                    Orientation="Horizontal"
                                                    Margin="0,0,0,4">
                                            <TextBlock Text="{Binding Role.Value,Mode=OneTime}"
                                                       FontWeight="SemiBold"
                                                       FontSize="12"
                                                       Foreground="{Binding Role, Converter={x:Static local:NavigationConverters.RoleToForeground},Mode=OneTime}" />

                                            <!-- 分叉标记 -->
                                            <Border Margin="8,0,0,0"
                                                    Padding="6,2"
                                                    CornerRadius="10"
                                                    Background="#FFF3E0"
                                                    BorderBrush="#FF9500"
                                                    BorderThickness="1"
                                                    Visibility="{Binding Children.Count, 
                                                Converter={x:Static converters:SnapConverters.EnumerableAnyToVisibilityConverter},Mode=OneWay}">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="⑂" FontSize="11" Margin="0,0,4,0"
                                                               Foreground="#FF6F00" />
                                                    <TextBlock FontSize="10"
                                                               FontWeight="SemiBold"
                                                               Foreground="#FF6F00">
                                                        <Run Text="{Binding Children.Count, Mode=OneWay}" />
                                                        <Run Text="个分支" />
                                                    </TextBlock>
                                                </StackPanel>
                                            </Border>
                                        </StackPanel>

                                        <!-- 内容文本 -->
                                        <TextBlock Grid.Row="1"
                                                   Text="{Binding DisplayText,Mode=OneWay}"
                                                   TextWrapping="Wrap"
                                                   FontSize="13"
                                                   Foreground="#333"
                                                   MaxWidth="550" />
                                    </Grid>
                                </Border>
                            </Grid>

                            <!-- ====== 第二行：子节点容器 ====== -->
                            <Grid Grid.Row="1" x:Name="ChildrenPanel">
                                <Grid.ColumnDefinitions>
                                    <!-- 连线延伸区域 -->
                                    <ColumnDefinition Width="48" />
                                    <!-- 子节点区域 -->
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <!-- 分叉线容器 -->
                                <Canvas Grid.Column="0"
                                        x:Name="ForkCanvas"
                                        ClipToBounds="False"
                                        Background="Transparent">
                                    <!-- 分叉线将由触发器动态生成 -->
                                </Canvas>

                                <!-- 子节点ItemsPresenter -->
                                <ItemsPresenter Grid.Column="1"
                                                x:Name="ItemsPresenter"
                                                Margin="0" />
                            </Grid>
                        </Grid>

                        <!-- ============================================ -->
                        <!-- 触发器：根据层级和兄弟关系显示不同连线 -->
                        <!-- ============================================ -->
                        <ControlTemplate.Triggers>
                            <!-- 有多个子节点时显示分叉标记 -->
                            <DataTrigger
                                Binding="{Binding Children.Count, 
                                    Converter={x:Static converters:SnapConverters.EnumerableAnyToVisibilityConverter}}"
                                Value="Visible">
                                <Setter TargetName="ForkMarker" Property="Visibility" Value="Visible" />
                                <Setter TargetName="NodeDot" Property="Visibility" Value="Collapsed" />
                            </DataTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <!-- 层级数据模板 -->
        <HierarchicalDataTemplate x:Key="ChatNodeTemplate"
                                  DataType="{x:Type local:BaseDialogItem}"
                                  ItemsSource="{Binding Children}">
            <!-- 内容由 TreeViewItem 模板处理 -->
        </HierarchicalDataTemplate>
    </UserControl.Resources>
    <Grid>
        <ScrollViewer VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Auto">
            <TreeView ItemsSource="{Binding RootNodes,Mode=OneWay}"
                      ItemContainerStyle="{StaticResource ChatTreeViewItemStyle}"
                      ItemTemplate="{StaticResource ChatNodeTemplate}"
                      Background="Transparent"
                      BorderThickness="0"
                      Padding="8"
                      SelectedItemChanged="TreeView_OnSelectedItemChanged"
                      VirtualizingStackPanel.IsVirtualizing="True"
                      VirtualizingStackPanel.VirtualizationMode="Recycling">
            </TreeView>
        </ScrollViewer>
    </Grid>
</UserControl>