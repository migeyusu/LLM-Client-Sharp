<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
                    xmlns:b="http://schemas.microsoft.com/xaml/behaviors"
                    xmlns:dialog="clr-namespace:LLMClient.Dialog"
                    xmlns:sys="clr-namespace:System;assembly=System.Runtime"
                    xmlns:utility="clr-namespace:LLMClient.Component.Utility"
                    xmlns:converters="clr-namespace:LLMClient.Component.Converters"
                    xmlns:customControl="clr-namespace:LLMClient.Component.CustomControl"
                    xmlns:component="clr-namespace:LLMClient.Component"
                    xmlns:ai="clr-namespace:Microsoft.Extensions.AI;assembly=Microsoft.Extensions.AI.Abstractions">
    <Style x:Key="SmallIconButtonStyle"
           TargetType="{x:Type Button}"
           BasedOn="{StaticResource MaterialDesignIconButton}">
        <Setter Property="Width"
                Value="28" />
        <Setter Property="Height"
                Value="28" />
    </Style>
    <Style x:Key="AutoHideMenuItemStyle"
           TargetType="MenuItem"
           BasedOn="{StaticResource {x:Type MenuItem}}">
        <Style.Triggers>
            <Trigger Property="IsEnabled" Value="False">
                <Setter Property="Visibility" Value="Collapsed" />
            </Trigger>
        </Style.Triggers>
    </Style>
    <DataTemplate x:Key="DefaultRequestViewItemDataTemplate"
                  DataType="{x:Type dialog:RequestViewItem}">
        <Grid HorizontalAlignment="Right"
              Margin="50,0,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition />
            </Grid.ColumnDefinitions>
            <StackPanel>
                <materialDesign:PopupBox StaysOpen="True"
                                         Width="30"
                                         Height="30"
                                         VerticalAlignment="Top"
                                         Margin="0,4,0,0">
                    <Menu Padding="0"
                          ItemsPanel="{StaticResource VerticalItemsPanelTemplate}">
                        <MenuItem Header="复制原始文本"
                                  Command="{x:Static utility:CommonCommands.CopyCommand}"
                                  CommandParameter="{Binding RawTextMessage, Mode=OneWay}"
                                  Icon="{materialDesign:PackIcon Kind=ContentCopy}" />
                        <MenuItem Header="显示Raw文本"
                                  IsCheckable="True"
                                  IsChecked="{Binding DisplayRawText,Mode=TwoWay}" />
                        <MenuItem Header="格式化请求"
                                  Command="{Binding FormatTextCommand}"
                                  Icon="{materialDesign:PackIcon Kind=FormatText}" />
                        <MenuItem Header="导出"
                                  ToolTip="导出为Markdown"
                                  Command="{x:Static utility:CommonCommands.ExportCommand}"
                                  CommandParameter="{Binding TextMessage,Mode=OneWay}"
                                  Icon="{materialDesign:PackIcon Kind=Export}" />
                        <Separator />
                        <MenuItem Header="总结之前对话"
                                  Command="{x:Static utility:CommonCommands.Conclusion}"
                                  CommandParameter="{Binding}"
                                  Icon="{materialDesign:PackIcon Kind=TagText}" />
                        <MenuItem Header="排除之前对话"
                                  ToolTip="将之前的对话清出上下文"
                                  Command="{x:Static utility:CommonCommands.Exclude}"
                                  CommandParameter="{Binding}"
                                  Icon="{materialDesign:PackIcon Kind=FormatAlignTop}" />
                        <!--<MenuItem Header="清空之前对话"
                                  ToolTip="删除之前的对话内容"
                                  Command="{x:Static utility:CommonCommands.Clear}"
                                  CommandParameter="{Binding}"
                                  Icon="{materialDesign:PackIcon Kind=WaveArrowUp}" />-->
                        <MenuItem Header="删除"
                                  Command="Delete"
                                  CommandParameter="{Binding}"
                                  Icon="{materialDesign:PackIcon Kind=DeleteOutline}" />
                    </Menu>
                </materialDesign:PopupBox>
                <Button Style="{StaticResource SmallIconButtonStyle}"
                        Content="{materialDesign:PackIcon Kind=PencilOutline,Size=20}"
                        ToolTip="编辑请求内容"
                        Command="{x:Static utility:CommonCommands.EditDialogItemCommand}"
                        CommandParameter="{Binding Mode=OneTime}"
                        Margin="0,4,0,0" />
                <ProgressBar IsIndeterminate="True"
                             Style="{StaticResource MaterialDesignCircularProgressBar}"
                             Value="0"
                             Margin="5"
                             Width="18"
                             Height="18"
                             Visibility="{Binding IsFormatting,Mode=TwoWay,Converter={StaticResource BooleanToVisibilityConverter}}" />
            </StackPanel>

            <StackPanel Grid.Column="1"
                        Margin="10,0,0,0">
                <materialDesign:Card Padding="0"
                                     UniformCornerRadius="8"
                                     BorderThickness="0"
                                     Background="{DynamicResource MaterialDesign.Brush.Primary.Light}"
                                     Foreground="{DynamicResource MaterialDesign.Brush.Primary.Light.Foreground}">
                    <StackPanel HorizontalAlignment="Right">
                        <customControl:FlowDocumentScrollViewerEx FontFamily="Segoe UI Emoji"
                                                                  BorderThickness="0"
                                                                  Padding="0"
                                                                  Visibility="{Binding DisplayRawText,Mode=OneWay,Converter={x:Static materialDesign:BooleanToVisibilityConverter.NotCollapsedInstance}}"
                                                                  HighlightableRanges="{Binding SearchableDocument.FoundTextRanges,Mode=OneWay}"
                                                                  SafeDocument="{Binding SearchableDocument.Document,Mode=OneWay}"
                                                                  Style="{StaticResource ExFlowDocumentScrollViewerStyle}">
                            <customControl:FlowDocumentScrollViewerEx.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Command="Copy"
                                              Header="复制选定"
                                              Icon="{materialDesign:PackIcon Kind=ContentCopy}" />
                                    <MenuItem Command="SelectAll"
                                              Header="全选"
                                              Icon="{materialDesign:PackIcon Kind=SelectAll}" />
                                </ContextMenu>
                            </customControl:FlowDocumentScrollViewerEx.ContextMenu>
                        </customControl:FlowDocumentScrollViewerEx>
                        <TextBlock TextWrapping="Wrap"
                                   Margin="16"
                                   Visibility="{Binding DisplayRawText,Mode=OneWay,Converter={StaticResource BooleanToVisibilityConverter}}"
                                   Style="{StaticResource MaterialDesignBody1TextBlock}"
                                   Text="{Binding TextMessage,Mode=OneWay}" />
                    </StackPanel>
                </materialDesign:Card>
                <ItemsControl ItemsSource="{Binding Attachments,Mode=OneTime}"
                              Margin="0,8,0,0"
                              HorizontalAlignment="Right"
                              Visibility="{Binding HasAttachments,Mode=OneTime,Converter={x:Static materialDesign:BooleanToVisibilityConverter.CollapsedInstance}}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type dialog:Attachment}">
                            <materialDesign:Chip IsDeletable="False"
                                                 MaxWidth="140"
                                                 Margin="0"
                                                 ToolTipService.InitialShowDelay="0"
                                                 ToolTip="{Binding OriUri,Mode=OneTime}"
                                                 Content="{Binding  Name,Mode=OneTime}"
                                                 Command="{x:Static dialog:Attachment.OpenFileCommand}"
                                                 CommandParameter="{Binding}">
                                <materialDesign:Chip.Icon>
                                    <materialDesign:PackIcon
                                        Kind="{Binding Type,Mode=OneWay,Converter={x:Static converters:AttachmentTypeConverter.Instance}}" />
                                </materialDesign:Chip.Icon>
                            </materialDesign:Chip>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel IsItemsHost="True" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
                <StackPanel Orientation="Horizontal"
                            Margin="0,8,0,0"
                            HorizontalAlignment="Right">
                    <TextBlock Text="{Binding Tokens,Mode=OneWay,StringFormat=Estimated Tokens:{0}}"
                               Style="{StaticResource MaterialDesignOverlineTextBlock}" />
                    <materialDesign:PackIcon Kind="Function"
                                             Visibility="{Binding HasFunctions,Mode=OneTime,Converter={StaticResource BooleanToVisibilityConverter}}"
                                             Margin="8,0,0,0" />
                    <materialDesign:PackIcon Kind="Web"
                                             Visibility="{Binding SearchOption,Mode=OneTime,Converter={x:Static materialDesign:NullableToVisibilityConverter.CollapsedInstance}}"
                                             Margin="8,0,0,0" />
                    <materialDesign:PackIcon Kind="DataMatrix"
                                             Visibility="{Binding HasRagSources,Mode=OneTime,Converter={x:Static materialDesign:BooleanToVisibilityConverter.CollapsedInstance}}"
                                             Margin="8,0,0,0" />
                </StackPanel>
            </StackPanel>
        </Grid>
    </DataTemplate>
    <DataTemplate x:Key="ResponseContentTemplate" DataType="{x:Type dialog:ResponseViewItem}">
        <StackPanel>
            <materialDesign:Card Padding="8"
                                 Visibility="{Binding IsResponding,Mode=OneWay,Converter={x:Static materialDesign:BooleanToVisibilityConverter.CollapsedInstance}}"
                                 Background="{DynamicResource MaterialDesign.Brush.Primary.Dark}"
                                 Foreground="{DynamicResource MaterialDesign.Brush.Primary.Dark.Foreground}">
                <StackPanel Orientation="Horizontal">
                    <Ellipse Width="10"
                             Height="10"
                             Fill="ForestGreen"
                             VerticalAlignment="Center" />
                    <TextBlock Text="正在生成文档。。。。。。。。"
                               Margin="10,0,0,0"
                               VerticalAlignment="Center" />
                </StackPanel>
            </materialDesign:Card>
            <customControl:FlowDocumentScrollViewerEx
                FontFamily="Segoe UI Emoji"
                BorderThickness="0"
                HighlightableRanges="{Binding SearchableDocument.FoundTextRanges,Mode=OneWay}"
                SafeDocument="{Binding SearchableDocument.Document,Mode=OneWay}"
                Style="{StaticResource ExFlowDocumentScrollViewerStyle}">
                <customControl:FlowDocumentScrollViewerEx.ContextMenu>
                    <ContextMenu>
                        <MenuItem Command="Copy"
                                  Header="复制选定">
                            <MenuItem.Icon>
                                <materialDesign:PackIcon
                                    Kind="ContentCopy" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Command="SelectAll"
                                  Header="全选">
                            <MenuItem.Icon>
                                <materialDesign:PackIcon
                                    Kind="SelectAll" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <Separator />
                        <MenuItem Header="复制文本"
                                  Command="{x:Static utility:CommonCommands.CopyCommand}"
                                  CommandParameter="{Binding Mode=OneTime}">
                            <MenuItem.Icon>
                                <materialDesign:PackIcon
                                    Kind="ContentCopy" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Header="导出"
                                  ToolTip="导出为Markdown"
                                  Command="{x:Static utility:CommonCommands.ExportCommand}"
                                  CommandParameter="{Binding TextContent,Mode=OneWay}">
                            <MenuItem.Icon>
                                <materialDesign:PackIcon
                                    Kind="Export" />
                            </MenuItem.Icon>
                        </MenuItem>
                    </ContextMenu>
                </customControl:FlowDocumentScrollViewerEx.ContextMenu>
            </customControl:FlowDocumentScrollViewerEx>
            <customControl:MarkdownTextBlock TextWrapping="Wrap"
                                             VerticalAlignment="Top"
                                             Visibility="{Binding IsResponding,Mode=OneWay,Converter={StaticResource BooleanToVisibilityConverter}}"
                                             Source="{Binding  TempResponseText,Mode=OneTime}" />
            <TextBox IsReadOnly="True"
                     materialDesign:TextFieldAssist.DecorationVisibility="Collapsed"
                     BorderThickness="0"
                     Text="{Binding ErrorMessage,Mode=OneWay}"
                     TextWrapping="Wrap"
                     Foreground="Red"
                     Padding="10"
                     Visibility="{Binding IsInterrupt,Mode=OneWay,Converter={x:Static materialDesign:BooleanToVisibilityConverter.CollapsedInstance}}" />
        </StackPanel>
    </DataTemplate>
    <DataTemplate x:Key="EraseDataTemplate"
                  DataType="{x:Type dialog:EraseViewItem}">
        <Grid Height="30">
            <Grid.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="删除"
                              Command="Delete"
                              CommandParameter="{Binding}">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="DeleteOutline" />
                        </MenuItem.Icon>
                    </MenuItem>
                </ContextMenu>
            </Grid.ContextMenu>
            <Grid.ColumnDefinitions>
                <ColumnDefinition />
                <ColumnDefinition />
            </Grid.ColumnDefinitions>
            <Separator HorizontalAlignment="Stretch"
                       Height="1"
                       Margin="50,0"
                       Foreground="Black" />
            <Separator Grid.Column="1"
                       HorizontalAlignment="Stretch"
                       Margin="50,0"
                       Height="1"
                       Foreground="Black" />
            <TextBlock Grid.Column="0" Text="上下文已清除"
                       Grid.ColumnSpan="2"
                       Padding="10,5"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Style="{DynamicResource MaterialDesignSubtitle2TextBlock}" />
        </Grid>
    </DataTemplate>
    <DataTemplate x:Key="UsageDetailDataTemplate"
                  DataType="{x:Type ai:UsageDetails}">
        <StackPanel Margin="10">
            <TextBlock Text="用量详情"
                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                       Margin="0,0,0,6" />
            <UniformGrid Columns="2"
                         Rows="3"
                         Margin="0,4,0,0">
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <materialDesign:PackIcon Kind="ArrowRightBoldBox" Width="18" Height="18" Margin="0,0,6,0" />
                    <TextBlock
                        Text="{Binding InputTokenCount,Mode=OneWay,StringFormat=输入 Tokens：{0},TargetNullValue=--}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <materialDesign:PackIcon Kind="ArrowLeftBoldBox" Width="18" Height="18" Margin="0,0,6,0" />
                    <TextBlock
                        Text="{Binding OutputTokenCount,Mode=OneWay,StringFormat=输出 Tokens：{0},TargetNullValue=--}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <materialDesign:PackIcon Kind="DatabasePlus" Width="18" Height="18" Margin="0,0,6,0" />
                    <TextBlock
                        Text="{Binding CachedInputTokenCount,Mode=OneWay,StringFormat=缓存 Tokens：{0},TargetNullValue=--}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <materialDesign:PackIcon Kind="Thinking" Width="18" Height="18" Margin="0,0,6,0" />
                    <TextBlock
                        Text="{Binding ReasoningTokenCount,Mode=OneWay,StringFormat=推理 Tokens：{0},TargetNullValue=--}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <materialDesign:PackIcon Kind="Sigma" Width="18" Height="18" Margin="0,0,6,0" />
                    <TextBlock
                        Text="{Binding TotalTokenCount,Mode=OneWay,StringFormat=总 Tokens：{0},TargetNullValue=--}" />
                </StackPanel>
            </UniformGrid>
        </StackPanel>
    </DataTemplate>
    <DataTemplate x:Key="MultiResponseViewItemDataTemplate"
                  DataType="{x:Type dialog:MultiResponseViewItem}">
        <StackPanel>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Grid HorizontalAlignment="Left">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <ListBox Height="45"
                             HorizontalAlignment="Right"
                             VerticalAlignment="Bottom"
                             VerticalContentAlignment="Bottom"
                             ScrollViewer.HorizontalScrollBarVisibility="Auto"
                             SelectedIndex="{Binding AcceptedIndex,Mode=TwoWay}"
                             Style="{StaticResource MaterialDesignChoiceChipPrimaryListBox}"
                             ItemsSource="{Binding Items,Mode=OneWay}"
                             ItemsPanel="{StaticResource HorizontalItemsPanelTemplate}">
                        <ListBox.ItemTemplate>
                            <DataTemplate DataType="{x:Type dialog:ResponseViewItem}">
                                <StackPanel Orientation="Horizontal"
                                            Margin="3"
                                            ToolTipService.InitialShowDelay="0"
                                            ToolTip="{Binding Model.Endpoint.DisplayName,Mode=OneTime}">
                                    <Button Width="32"
                                            Height="32"
                                            Padding="0"
                                            Margin="-10,0,6,0"
                                            VerticalAlignment="Center"
                                            Visibility="{Binding IsResponding,Mode=OneWay,Converter={StaticResource BooleanToVisibilityConverter}}"
                                            Command="{Binding CancelCommand}"
                                            Style="{StaticResource MaterialDesignIconButton}">
                                        <Grid>
                                            <ProgressBar IsIndeterminate="True"
                                                         Foreground="{DynamicResource MaterialDesign.Brush.Secondary}"
                                                         Width="26"
                                                         Height="26"
                                                         Style="{StaticResource MaterialDesignCircularProgressBar}"
                                                         Value="0" />
                                            <materialDesign:PackIcon Width="17"
                                                                     Height="17"
                                                                     Kind="Stop"
                                                                     Foreground="{DynamicResource MaterialDesign.Brush.Secondary}"
                                                                     VerticalAlignment="Center"
                                                                     HorizontalAlignment="Center" />
                                        </Grid>
                                    </Button>
                                    <Image VerticalAlignment="Center"
                                           RenderOptions.BitmapScalingMode="HighQuality"
                                           Source="{Binding Model.Icon.CurrentSource,Mode=OneWay}"
                                           Width="26"
                                           Height="26" />
                                    <TextBlock Text="{Binding ModelName,Mode=OneTime}"
                                               VerticalAlignment="Center"
                                               Margin="6,0,0,0"
                                               MaxWidth="200"
                                               TextTrimming="CharacterEllipsis"
                                               Style="{StaticResource MaterialDesignSubtitle2TextBlock}" />
                                    <materialDesign:PackIcon Kind="ExclamationThick"
                                                             Foreground="Red"
                                                             Height="30"
                                                             Width="30"
                                                             VerticalAlignment="Center"
                                                             Margin="-5,0"
                                                             ToolTip="当前回复有错误，将不加入对话上下文"
                                                             Visibility="{Binding IsAvailableInContext,Mode=OneWay,Converter={x:Static materialDesign:BooleanToVisibilityConverter.NotCollapsedInstance}}" />
                                    <Border BorderThickness="0"
                                            Margin="6,0,-6,0"
                                            VerticalAlignment="Center"
                                            Visibility="{Binding IsResponding,Mode=OneWay,Converter={x:Static materialDesign:BooleanToVisibilityConverter.NotCollapsedInstance}}">
                                        <Button Width="16"
                                                Height="16"
                                                Command="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType=ListBox},Path=DataContext.RemoveResponseCommand}"
                                                Visibility="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType=ListBox},Path=DataContext.IsMultiResponse,Mode=OneWay,Converter={x:Static materialDesign:BooleanToVisibilityConverter.CollapsedInstance}}"
                                                CommandParameter="{Binding  }"
                                                ToolTip="删除当前"
                                                Template="{StaticResource ItemDeleteButtonTemplate}" />
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                        <ListBox.Resources>
                            <Style TargetType="{x:Type ScrollViewer}"
                                   BasedOn="{StaticResource HorizontalArrowScrollViewer}" />
                        </ListBox.Resources>
                    </ListBox>
                    <StackPanel Grid.Column="1"
                                Orientation="Horizontal"
                                VerticalAlignment="Bottom">
                        <Menu VerticalAlignment="Center"
                              Margin="10,0,0,0">
                            <MenuItem Icon="{materialDesign:PackIcon Kind=MoreVert,Size=18}"
                                      Width="18"
                                      Height="45"
                                      Padding="0">
                                <MenuItem Header="删除其他回复"
                                          Icon="{materialDesign:PackIcon Kind=Clear}"
                                          Command="{Binding ClearOthersCommand}" />
                                <MenuItem Header="由此创建新分支"
                                          Command="{Binding NewBranchCommand}"
                                          Icon="{materialDesign:PackIcon SourceBranchPlus}"
                                          Style="{StaticResource AutoHideMenuItemStyle}" />
                                <MenuItem Header="移除之后消息"
                                          Command="{x:Static dialog:MultiResponseViewItem.RebaseCommand}"
                                          CommandParameter="{Binding Mode=OneTime}"
                                          ToolTip="保留当前消息并删除所有之后的消息"
                                          Icon="{materialDesign:PackIcon Kind=WaveArrowDown}" />
                                <MenuItem Header="标记为有效回复"
                                          IsCheckable="True"
                                          IsChecked="{Binding AcceptedResponse.IsManualValid,Mode=TwoWay}"
                                          Visibility="{Binding AcceptedResponse.IsInterrupt,Mode=OneWay,Converter={x:Static materialDesign:BooleanToVisibilityConverter.CollapsedInstance}}" />
                            </MenuItem>
                        </Menu>
                        <materialDesign:PopupBox Padding="4,0"
                                                 StaysOpen="True"
                                                 PopupUniformCornerRadius="8"
                                                 VerticalAlignment="Center"
                                                 ToolTip="添加其他模型"
                                                 Margin="10,0,0,0"
                                                 Foreground="{DynamicResource MaterialDesign.Brush.Primary}"
                                                 ToggleContent="{materialDesign:PackIcon Kind=AddBold,Size=20}"
                                                 Style="{StaticResource MaterialDesignToolPopupBox}"
                                                 PopupContent="{Binding  SelectionPopup,Mode=OneTime}"
                                                 PopupContentTemplate="{StaticResource  PopupSelectModelDataTemplate}" />
                        <Button Style="{StaticResource SmallIconButtonStyle}"
                                VerticalAlignment="Center"
                                Margin="6,0,0,0"
                                ToolTip="重试"
                                Command="{x:Static  dialog:MultiResponseViewItem.RetryCurrentCommand}"
                                CommandParameter="{Binding}"
                                Content="{materialDesign:PackIcon Kind=Refresh,Size=20}" />
                        <Button Style="{StaticResource SmallIconButtonStyle}"
                                Command="{x:Static utility:CommonCommands.EditDialogItemCommand}"
                                CommandParameter="{Binding  Mode=OneTime}"
                                VerticalAlignment="Center"
                                Margin="6,0,0,0"
                                ToolTip="编辑当前回复"
                                Content="{materialDesign:PackIcon Kind=PencilOutline,Size=20}" />
                        <Button Style="{StaticResource SmallIconButtonStyle}"
                                Command="{x:Static utility:CommonCommands.CopyCommand}"
                                CommandParameter="{Binding AcceptedResponse,Mode=OneWay}"
                                VerticalAlignment="Center"
                                Margin="6,0,0,0"
                                ToolTip="复制（仅文本）"
                                Content="{materialDesign:PackIcon Kind=ContentCopy,Size=20}" />
                        <Button Style="{StaticResource SmallIconButtonStyle}"
                                Command="{x:Static dialog:MultiResponseViewItem.CompareAllCommand}"
                                CommandParameter="{Binding Mode=OneTime}"
                                VerticalAlignment="Center"
                                Margin="6,0,0,0"
                                ToolTip="对比所有响应"
                                Content="{materialDesign:PackIcon Kind=Compare,Size=20}" />
                    </StackPanel>
                </Grid>
                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center"
                            Margin="16,0,0,0">
                    <TextBlock Text="在上下文中有效"
                               VerticalAlignment="Center" />
                    <ToggleButton Command="{x:Static dialog:MultiResponseViewItem.SetAsAvailableCommand}"
                                  CommandParameter="{Binding AcceptedResponse,Mode=OneWay}"
                                  VerticalAlignment="Center"
                                  Margin="6,0"
                                  ToolTip="通过将当前回复设置为在上下文中有效，可以跳过一些回复，减少上下文的长度"
                                  IsChecked="{Binding AcceptedResponse.IsAvailableInContext,Mode=OneWay}" />
                </StackPanel>
            </Grid>
            <materialDesign:Card Padding="0"
                                 UniformCornerRadius="8"
                                 HorizontalAlignment="Stretch"
                                 BorderThickness="0"
                                 Style="{StaticResource MaterialDesignOutlinedCard}">
                <ContentControl Content="{Binding AcceptedResponse,Mode=OneWay}"
                                ContentTemplate="{StaticResource ResponseContentTemplate}" />
            </materialDesign:Card>
            <StackPanel Orientation="Horizontal">
                <TextBlock DataContext="{Binding AcceptedResponse,Mode=OneWay}"
                           HorizontalAlignment="Left"
                           Margin="0,6,0,0">
                    <TextBlock.Text>
                        <MultiBinding
                            StringFormat="Completion Tokens: {0}, Price：{1:F4}$，Latency: {2}ms, Duration:{3}s, Speed:{4:F1}tps">
                            <Binding Path="Tokens" Mode="OneWay" TargetNullValue="None" />
                            <Binding Path="Price" Mode="OneWay" TargetNullValue="None" />
                            <Binding Path="Latency" Mode="OneWay" TargetNullValue="None" />
                            <Binding Path="Duration" Mode="OneWay" TargetNullValue="None" />
                            <Binding Path="TpS" Mode="OneWay" TargetNullValue="None" />
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
                <materialDesign:PopupBox ToolTip="模型信息"
                                         Margin="10,0,0,0"
                                         Width="30"
                                         Height="30"
                                         Visibility="{Binding AcceptedResponse.Usage,Mode=OneWay,Converter={x:Static materialDesign:NullableToVisibilityConverter.CollapsedInstance}}"
                                         ToggleContent="{materialDesign:PackIcon Kind=InfoOutline}"
                                         PopupAnimation="Slide"
                                         PopupUniformCornerRadius="8"
                                         Padding="4,0"
                                         VerticalAlignment="Center"
                                         PopupContent="{Binding AcceptedResponse.Usage,Mode=OneWay}"
                                         PopupContentTemplate="{StaticResource UsageDetailDataTemplate}" />
            </StackPanel>
        </StackPanel>
    </DataTemplate>
    <component:TypeBasedDataTemplateSelector x:Key="DialogTemplateSelector">
        <component:DataTemplateTypePair Template="{StaticResource DefaultRequestViewItemDataTemplate}" />
        <component:DataTemplateTypePair Template="{StaticResource MultiResponseViewItemDataTemplate}" />
        <component:DataTemplateTypePair>
            <DataTemplate DataType="{x:Type dialog:SummaryRequestViewItem}">
                <Grid HorizontalAlignment="Right"
                      Margin="50,0,0,0">
                    <Grid.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="删除"
                                      Command="Delete"
                                      CommandParameter="{Binding}">
                                <MenuItem.Icon>
                                    <materialDesign:PackIcon Kind="DeleteOutline" />
                                </MenuItem.Icon>
                            </MenuItem>
                        </ContextMenu>
                    </Grid.ContextMenu>
                    <Rectangle Stroke="Black"
                               StrokeThickness="1.5"
                               RadiusX="8" RadiusY="8"
                               StrokeDashArray="6,2"
                               SnapsToDevicePixels="True" />
                    <TextBlock TextWrapping="Wrap"
                               Margin="8"
                               materialDesign:TextFieldAssist.DecorationVisibility="Collapsed"
                               Text="{Binding SummaryPrompt,Mode=OneTime}" />
                </Grid>
            </DataTemplate>
        </component:DataTemplateTypePair>
        <component:DataTemplateTypePair Template="{StaticResource EraseDataTemplate}" />
    </component:TypeBasedDataTemplateSelector>
    <Style x:Key="DialogListBoxStyle"
           TargetType="{x:Type customControl:ListBoxEx}"
           BasedOn="{StaticResource {x:Type ListBox}}">
        <Setter Property="Margin" Value="0,0,5,5" />
        <Setter Property="VirtualizingPanel.IsVirtualizing" Value="True" />
        <Setter Property="VirtualizingPanel.VirtualizationMode" Value="Recycling" />
        <Setter Property="VirtualizingPanel.CacheLengthUnit" Value="Item" />
        <Setter Property="VirtualizingPanel.CacheLength" Value="15,15" />
        <Setter Property="VirtualizingPanel.ScrollUnit" Value="Pixel" />
        <Setter Property="VirtualizingPanel.IsContainerVirtualizable" Value="True" />
        <Setter Property="materialDesign:ListBoxItemAssist.ShowSelection" Value="False" />
        <Setter Property="SelectionMode" Value="Single" />
        <Setter Property="ItemsPanel">
            <Setter.Value>
                <ItemsPanelTemplate>
                    <customControl:CustomVirtualizingStackPanel IsItemsHost="True" />
                </ItemsPanelTemplate>
            </Setter.Value>
        </Setter>
        <Setter Property="ItemContainerStyle">
            <Setter.Value>
                <Style TargetType="{x:Type ListBoxItem}" BasedOn="{StaticResource MaterialDesignListBoxItem}">
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="Margin" Value="0,10,6,0" />
                </Style>
            </Setter.Value>
        </Setter>
        <Setter Property="ItemTemplateSelector"
                Value="{StaticResource DialogTemplateSelector}" />
    </Style>
    <DataTemplate x:Key="ThinkingConfigDataTemplate"
                  DataType="{x:Type dialog:ThinkingConfigViewModel}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition />
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition />
            </Grid.ColumnDefinitions>
            <ListBox Grid.Column="1"
                     ItemsSource="{Binding EffortLevels,Mode=OneTime}"
                     SelectedIndex="0"
                     SelectedItem="{Binding EffortLevel,Mode=TwoWay}"
                     SelectionMode="Single">
                <ListBox.Style>
                    <Style TargetType="ListBox"
                           BasedOn="{StaticResource MaterialDesignToolToggleFlatListBox}">
                        <Setter Property="ItemContainerStyle">
                            <Setter.Value>
                                <Style TargetType="ListBoxItem"
                                       BasedOn="{StaticResource MaterialDesignToolToggleListBoxItem}">
                                    <Setter
                                        Property="HorizontalContentAlignment"
                                        Value="Center" />
                                    <Setter Property="VerticalContentAlignment"
                                            Value="Center" />
                                    <Setter Property="MinWidth" Value="54" />
                                    <Setter Property="Height"
                                            Value="30" />
                                    <Setter Property="Padding" Value="6,3" />
                                    <Setter Property="TextBlock.FontSize"
                                            Value="16" />
                                    <Setter Property="TextBlock.FontWeight"
                                            Value="Black" />
                                </Style>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.Style>
            </ListBox>
            <TextBlock Grid.Row="0" Grid.Column="0" Text="Effort Level:"
                       Margin="0,0,8,0"
                       Style="{StaticResource MaterialDesignSubtitle2TextBlock}"
                       VerticalAlignment="Center" />
            <CheckBox Grid.Row="1" Grid.Column="0"
                      Grid.ColumnSpan="2"
                      HorizontalAlignment="Left"
                      materialDesign:CheckBoxAssist.CheckBoxSize="26"
                      Margin="0,6,0,0"
                      IsChecked="{Binding EnableBudgetTokens,Mode=TwoWay}">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Budget Tokens:"
                               VerticalAlignment="Center"
                               Style="{StaticResource MaterialDesignSubtitle2TextBlock}" />
                    <TextBox
                        Margin="6,0,0,0"
                        Padding="8,6"
                        Width="80"
                        Style="{StaticResource MaterialDesignOutlinedTextBox}"
                        VerticalAlignment="Center">
                        <TextBox.Text>
                            <Binding Path="BudgetTokens" Mode="TwoWay">
                                <Binding.ValidationRules>
                                    <component:TypeValidateRule
                                        TargetType="{x:Type sys:Int32}" />
                                </Binding.ValidationRules>
                            </Binding>
                        </TextBox.Text>
                    </TextBox>
                </StackPanel>
            </CheckBox>
            <CheckBox Grid.Row="2" Grid.Column="0"
                      Grid.ColumnSpan="2"
                      HorizontalAlignment="Left"
                      Margin="0,6,0,0"
                      FontSize="14"
                      Content="Show thinking details."
                      materialDesign:CheckBoxAssist.CheckBoxSize="26"
                      IsChecked="{Binding ShowThinking,Mode=TwoWay}" />
        </Grid>
    </DataTemplate>
</ResourceDictionary>