<UserControl x:Class="LLMClient.Project.ProjectView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:converters="clr-namespace:LLMClient.UI.Component.Converters"
             xmlns:ui="clr-namespace:LLMClient.UI"
             xmlns:component="clr-namespace:LLMClient.UI.Component"
             xmlns:local="clr-namespace:LLMClient.Project"
             xmlns:dialog="clr-namespace:LLMClient.Dialog"
             xmlns:extension="clr-namespace:LLMClient.UI.Component.Extension"
             xmlns:customControl="clr-namespace:LLMClient.UI.Component.CustomControl"
             xmlns:utility="clr-namespace:LLMClient.UI.Component.Utility"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance local:ProjectViewModel}"
             d:DesignHeight="800" d:DesignWidth="1200">
    <Grid Margin="10,0,10,6">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <materialDesign:Card Grid.Row="0"
                             Margin="0,0,0,5"
                             Padding="10,4"
                             Height="50">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBox Text="{Binding  Name,Mode=TwoWay}"
                         Style="{StaticResource MaterialDesignFilledTextBox}"
                         materialDesign:HintAssist.Hint="名称"
                         HorizontalAlignment="Left"
                         MaxHeight="40"
                         Padding="0,10,6,0"
                         VerticalScrollBarVisibility="Auto"
                         MinWidth="100"
                         MaxWidth="300"
                         TextWrapping="Wrap" />
                <ui:PromptEditor Grid.Column="1"
                                        VerticalAlignment="Stretch"
                                        Margin="0,0,10,0"
                                        Header="Project Description"
                                        Source="{Binding Source={StaticResource PromptsResource}, Path=SystemPrompts,Mode=OneWay}"
                                        PromptString="{Binding Description,Mode=TwoWay,UpdateSourceTrigger=LostFocus}" />
                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            IsEnabled="{Binding IsBusy,Mode=OneWay,Converter={StaticResource InvertBooleanConverter}}">
                    <StackPanel.Resources>
                        <Style TargetType="{x:Type Button}"
                               BasedOn="{StaticResource MaterialDesignIconButton}">
                            <Setter Property="ToolTipService.InitialShowDelay" Value="0" />
                            <Setter Property="Width"
                                    Value="36" />
                            <Setter Property="Height"
                                    Value="36" />
                            <Setter Property="Margin"
                                    Value="6,0" />
                        </Style>
                    </StackPanel.Resources>
                    <TextBlock MaxWidth="140"
                               TextWrapping="Wrap"
                               HorizontalAlignment="Right"
                               Margin="0,0,10,0"
                               VerticalAlignment="Center"
                               Style="{StaticResource MaterialDesignOverlineTextBlock}">
                        <Run Text="{Binding TokensConsumption, Mode=OneWay,StringFormat=Total Tokens:{0}}" />
                        <LineBreak />
                        <Run Text="{Binding TotalPrice, Mode=OneWay,StringFormat=Total Cost:{0:F2}$}" />
                    </TextBlock>
                    <Button Content="{materialDesign:PackIcon Kind=CogOutline,Size=20}"
                            ToolTip="Config Project"
                            Command="{x:Static materialDesign:DialogHost.OpenDialogCommand}"
                            CommandParameter="{Binding ConfigViewModel,Mode=OneTime}" />
                    <Button ToolTip="备份"
                            Content="{materialDesign:PackIcon Kind=ArchiveArrowUpOutline,Size=20}"
                            Command="{x:Static utility:CommonCommands.Backup}" />
                    <materialDesign:PopupBox StaysOpen="True">
                        <StackPanel MaxWidth="200"
                                    MaxHeight="200">
                            <Button Content="打开项目文件夹"
                                    CommandParameter="{Binding FolderPath,Mode=OneWay}"
                                    Command="{x:Static utility:CommonCommands.OpenFolderCommand}" />
                            <Button Content="打开文件"
                                    Command="{x:Static utility:CommonCommands.OpenSource}" />
                        </StackPanel>
                    </materialDesign:PopupBox>
                </StackPanel>
            </Grid>
        </materialDesign:Card>
        <Expander Grid.Row="1"
                  materialDesign:ExpanderAssist.ExpanderButtonPosition="Start"
                  materialDesign:ExpanderAssist.HorizontalHeaderPadding="12,4">
            <Expander.Header>
                <Grid Height="50">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <StackPanel Margin="4"
                                Orientation="Horizontal">
                        <StackPanel.Resources>
                            <Style TargetType="{x:Type Button}"
                                   BasedOn="{StaticResource MaterialDesignFloatingActionMiniDarkButton}">
                                <Setter Property="VerticalAlignment"
                                        Value="Center" />
                                <Setter Property="Height"
                                        Value="30" />
                                <Setter Property="Width"
                                        Value="30" />
                                <Setter Property="Margin"
                                        Value="10,0,0,0" />
                            </Style>
                        </StackPanel.Resources>
                        <TextBlock Text="Tasks"
                                   VerticalAlignment="Center"
                                   Style="{StaticResource MaterialDesignHeadline6TextBlock}" />
                        <Button Content="{materialDesign:PackIcon Kind=Add,Size=16}"
                                Command="{Binding NewTaskCommand}"
                                Margin="16,0,0,0"
                                ToolTip="Add Tasks" />
                    </StackPanel>
                    <TextBox Grid.Column="1"
                             Text="{Binding SelectedTask.SystemPrompt,Mode=OneWay,StringFormat=上下文：{0}}"
                             materialDesign:TextFieldAssist.DecorationVisibility="Collapsed"
                             BorderThickness="0"
                             HorizontalAlignment="Stretch"
                             Padding="0"
                             Margin="16,0"
                             TextWrapping="Wrap"
                             VerticalAlignment="Center"
                             TextAlignment="Left"
                             IsReadOnly="True"
                             MaxHeight="45"
                             VerticalScrollBarVisibility="Auto" />
                    <StackPanel Grid.Column="2"
                                Orientation="Horizontal"
                                DataContext="{Binding SelectedTask,Mode=OneWay}"
                                Visibility="{Binding Mode=OneWay,Converter={x:Static materialDesign:NullableToVisibilityConverter.CollapsedInstance}}"
                                IsEnabled="{Binding IsBusy,Mode=OneWay,Converter={StaticResource InvertBooleanConverter}}">
                        <StackPanel.Resources>
                            <Style TargetType="{x:Type Button}"
                                   BasedOn="{StaticResource MaterialDesignIconButton}">
                                <Setter Property="ToolTipService.InitialShowDelay" Value="0" />
                                <Setter Property="Width"
                                        Value="36" />
                                <Setter Property="Height"
                                        Value="36" />
                            </Style>
                        </StackPanel.Resources>
                        <Button VerticalAlignment="Center"
                                Style="{StaticResource MaterialDesignFloatingActionMiniButton}"
                                Width="30"
                                Height="30"
                                Margin="0,0,10,0"
                                Visibility="{Binding Mode=OneWay,Converter={x:Static materialDesign:NullableToVisibilityConverter.CollapsedInstance}}"
                                Content="{materialDesign:PackIcon Kind=Eye}"
                                Command="{x:Static materialDesign:DialogHost.OpenDialogCommand}"
                                CommandParameter="{Binding PromptTemplate,Mode=OneWay}" />
                        <TextBlock MaxWidth="140"
                                   TextWrapping="Wrap"
                                   HorizontalAlignment="Right"
                                   Margin="0,0,10,0"
                                   VerticalAlignment="Center"
                                   Style="{StaticResource MaterialDesignOverlineTextBlock}">
                            <Run Text="{Binding TokensConsumption, Mode=OneWay,StringFormat=Total Tokens:{0}}" />
                            <LineBreak />
                            <Run Text="{Binding TotalPrice, Mode=OneWay,StringFormat=Total Cost:{0:F2}$}" />
                        </TextBlock>
                        <customControl:SearchBox Margin="10,0"
                                             Padding="8,4,8,4"
                                             Panel.ZIndex="1"
                                             VerticalAlignment="Center"
                                             Text="{Binding SearchText,Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}"
                                             SearchCommand="{Binding SearchCommand}"
                                             GoToNextCommand="{Binding GoToNextHighlightCommand}"
                                             GoToPreviousCommand="{Binding GoToPreviousHighlightCommand}" />
                        <Button ToolTip="清空对话"
                                Command="{Binding ClearDialogCommand}">
                            <materialDesign:PackIcon Kind="Delete"
                                                     Width="20"
                                                     Height="20" />
                        </Button>
                        <Button ToolTip="清空上下文"
                                Command="{Binding ClearContextCommand}">
                            <materialDesign:PackIcon Kind="Eraser"
                                                     Width="20"
                                                     Height="20" />
                        </Button>
                        <Button ToolTip="导出对话为Markdown"
                                Command="{Binding ExportCommand}">
                            <materialDesign:PackIcon Kind="FileExport"
                                                     Width="20"
                                                     Height="20" />
                        </Button>
                    </StackPanel>
                </Grid>
            </Expander.Header>
            <!--tasks listbox-->
            <ListBox MaxHeight="220"
                     Margin="0,10"
                     SelectedItem="{Binding SelectedTask,Mode=TwoWay}"
                     ItemsSource="{Binding Tasks,Mode=OneWay}">
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel IsItemsHost="True" />
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="{x:Type local:ProjectTaskViewModel}">
                        <materialDesign:Card Width="220"
                                             Height="100"
                                             Padding="3"
                                             BorderThickness="1"
                                             materialDesign:ElevationAssist.Elevation="Dp4"
                                             Style="{StaticResource MaterialDesignOutlinedCard}">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBox Text="{Binding Name,Mode=TwoWay}"
                                         materialDesign:TextFieldAssist.DecorationVisibility="Collapsed"
                                         materialDesign:HintAssist.Hint="Task Name"
                                         Margin="0"
                                         Padding="0"
                                         TextWrapping="NoWrap"
                                         BorderThickness="0"
                                         VerticalAlignment="Top"
                                         FontSize="18"
                                         FontWeight="Bold" />
                                <StackPanel Grid.Row="0" Grid.Column="1"
                                            Orientation="Horizontal">
                                    <Button HorizontalAlignment="Right"
                                            VerticalAlignment="Top"
                                            Style="{StaticResource ListBoxHoverButtonStyle}"
                                            Width="23"
                                            Height="23"
                                            Background="White"
                                            Content="{materialDesign:PackIcon Kind=ArrowLeftBold,Size=20}"
                                            Command="MoveLeft"
                                            CommandParameter="{Binding Mode=OneTime}" />
                                    <Button Style="{StaticResource MaterialDesignIconForegroundButton}"
                                            Template="{StaticResource ItemDeleteButtonTemplate}"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Top"
                                            Command="Delete"
                                            CommandParameter="{Binding Mode=OneTime}"
                                            Margin="6,0,0,0"
                                            Width="23"
                                            Height="23" />
                                </StackPanel>
                                <Grid Grid.Row="1" Grid.Column="0"
                                      Grid.ColumnSpan="2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock VerticalAlignment="Center"
                                               Text="{Binding Type,Mode=OneWay,Converter={x:Static converters:SnapConverters.EnumToDescriptionConverter}}" />
                                    <TextBlock Grid.Column="1"
                                               Margin="6,0,0,0"
                                               Style="{StaticResource MaterialDesignOverlineTextBlock}"
                                               TextWrapping="Wrap"
                                               TextTrimming="CharacterEllipsis"
                                               MaxHeight="30"
                                               Foreground="DimGray"
                                               VerticalAlignment="Center"
                                               Text="{Binding  Description,Mode=OneWay}" />
                                </Grid>
                                <CheckBox Grid.Row="2"
                                          Grid.Column="0"
                                          Grid.ColumnSpan="2"
                                          IsChecked="{Binding EnableInContext,Mode=TwoWay}"
                                          Content="Enable In Context"
                                          VerticalContentAlignment="Center" />
                                <materialDesign:PopupBox Grid.Row="2"
                                                         Grid.Column="1"
                                                         StaysOpen="True"
                                                         PopupUniformCornerRadius="4"
                                                         HorizontalAlignment="Right">
                                    <StackPanel Width="400"
                                                MaxHeight="600">
                                        <StackPanel.Resources>
                                            <Style TargetType="{x:Type TextBox}"
                                                   BasedOn="{StaticResource MaterialDesignTextBox}">
                                                <Setter Property="Margin"
                                                        Value="8,8,8,8" />
                                                <Setter Property="materialDesign:HintAssist.IsFloating"
                                                        Value="True" />
                                                <Setter Property="TextAlignment"
                                                        Value="Left" />
                                                <Setter Property="SpellCheck.IsEnabled"
                                                        Value="True" />
                                            </Style>
                                        </StackPanel.Resources>
                                        <TextBox materialDesign:HintAssist.Hint="Name"
                                                 Text="{Binding Name,Mode=TwoWay}" />
                                        <TextBox materialDesign:HintAssist.Hint="Description"
                                                 TextWrapping="Wrap"
                                                 AcceptsReturn="True"
                                                 AcceptsTab="True"
                                                 VerticalScrollBarVisibility="Auto"
                                                 MaxHeight="200"
                                                 Text="{Binding Description,Mode=TwoWay,UpdateSourceTrigger=LostFocus}" />
                                        <ComboBox Margin="8"
                                                  ItemsSource="{Binding Source={extension:EnumBindingSource {x:Type local:ProjectTaskType}}}"
                                                  SelectedValue="{Binding Type,Mode=TwoWay}"
                                                  materialDesign:HintAssist.Hint="Type"
                                                  materialDesign:HintAssist.IsFloating="True"
                                                  MaxDropDownHeight="200" />
                                        <TextBox materialDesign:HintAssist.Hint="Summary"
                                                 materialDesign:HintAssist.HelperText="Summary can be added to the context of subsequent tasks."
                                                 TextWrapping="Wrap"
                                                 AcceptsReturn="True"
                                                 AcceptsTab="True"
                                                 VerticalScrollBarVisibility="Auto"
                                                 MaxHeight="300"
                                                 Text="{Binding Summary,Mode=TwoWay,UpdateSourceTrigger=LostFocus}" />
                                    </StackPanel>
                                </materialDesign:PopupBox>
                            </Grid>
                        </materialDesign:Card>
                    </DataTemplate>
                </ListBox.ItemTemplate>
                <ListBox.CommandBindings>
                    <CommandBinding Command="Delete"
                                    Executed="TaskDelete_OnExecuted" />
                    <CommandBinding Command="MoveLeft"
                                    Executed="TaskMoveLeft_OnExecuted" />
                </ListBox.CommandBindings>
            </ListBox>
        </Expander>
        <Border Grid.Row="1"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="0,0,0,1" />
        <Grid Grid.Row="2"
              Margin="0,4"
              DataContext="{Binding SelectedTask,Mode=OneWay}"
              Visibility="{Binding Converter={x:Static materialDesign:NullableToVisibilityConverter.CollapsedInstance}}">
            <customControl:ListBoxEx Grid.Row="0"
                                 Style="{StaticResource DialogListBoxStyle}"
                                 CurrentVisibleItem="{Binding ScrollViewItem,Mode=TwoWay}"
                                 ItemsSource="{Binding DialogItems,Mode=OneWay}">
                <customControl:ListBoxEx.ContextMenu>
                    <ContextMenu>
                        <MenuItem Icon="{materialDesign:PackIcon Kind=ClipboardArrowDown}"
                                  Header="黏贴对话"
                                  Command="{Binding PastInteractionCommand}" />
                    </ContextMenu>
                </customControl:ListBoxEx.ContextMenu>
                <ListBox.CommandBindings>
                    <CommandBinding Command="{x:Static utility:CommonCommands.Fork}"
                                    Executed="ProjectBranch_OnExecuted" />
                    <CommandBinding Command="Delete"
                                    Executed="OnDeleteExecuted" />
                    <CommandBinding Command="{x:Static utility:CommonCommands.Exclude}"
                                    Executed="OnExcludeExecuted" />
                    <CommandBinding Command="{x:Static utility:CommonCommands.Clear}"
                                    Executed="ClearBefore_OnExecuted" />
                    <CommandBinding Command="{x:Static utility:CommonCommands.Conclusion}"
                                    Executed="ConclusionBefore_OnExecuted" />
                </ListBox.CommandBindings>
            </customControl:ListBoxEx>
            <StackPanel Grid.Row="0"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Bottom"
                        Margin="0,0,26,10">
                <StackPanel.Resources>
                    <Style TargetType="{x:Type Button}"
                           BasedOn="{StaticResource MaterialDesignFloatingActionMiniDarkButton}">
                        <Setter Property="Margin"
                                Value="0,10,0,0" />
                        <Setter Property="Width"
                                Value="26" />
                        <Setter Property="Height"
                                Value="26" />
                    </Style>
                </StackPanel.Resources>
                <Button Command="{Binding ScrollToTopCommand}"
                        Content="{materialDesign:PackIcon Kind=FormatVerticalAlignTop}" />
                <Button Command="{Binding ScrollToPreviousCommand}"
                        Content="{materialDesign:PackIcon Kind=ArrowUpBold}" />
                <Button Command="{Binding ScrollToNextCommand}"
                        Content="{materialDesign:PackIcon Kind=ArrowDownBold}" />
                <Button Command="{Binding ScrollToEndCommand}"
                        Content="{materialDesign:PackIcon Kind=FormatVerticalAlignBottom}" />
            </StackPanel>
        </Grid>
        <Border Grid.Row="3"
                BorderThickness="0"
                Visibility="{Binding SelectedTask,Mode=OneWay,Converter={x:Static materialDesign:NullableToVisibilityConverter.CollapsedInstance}}"
                IsEnabled="{Binding  IsBusy,Mode=OneWay,Converter={StaticResource InvertBooleanConverter}}"
                Margin="0,4,0,0">
            <dialog:RequesterView DataContext="{Binding Requester,Mode=OneTime}" />
        </Border>
        <Button Grid.Row="3"
                Command="{Binding SelectedTask.CancelLastCommand}">
            <Button.Style>
                <Style TargetType="Button"
                       BasedOn="{StaticResource StopButtonStyle}">
                    <Setter Property="Visibility" Value="Collapsed" />
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding SelectedTask.IsNewResponding}" Value="True">
                            <Setter Property="Visibility" Value="Visible" />
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Button.Style>
        </Button>
    </Grid>
</UserControl>