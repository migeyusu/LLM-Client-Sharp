<UserControl x:Class="LLMClient.UI.Dialog.RequesterView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:LLMClient.UI.Dialog"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:converters="clr-namespace:LLMClient.UI.Component.Converters"
             xmlns:mcp="clr-namespace:LLMClient.UI.MCP"
             xmlns:abstraction="clr-namespace:LLMClient.Abstraction"
             xmlns:component="clr-namespace:LLMClient.UI.Component"
             xmlns:sys="clr-namespace:System;assembly=System.Runtime"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance local:RequesterViewModel}"
             d:DesignHeight="300" d:DesignWidth="800">
    <UserControl.Resources>
        <KeyBinding x:Key="PromptKeyBinding"
                    Key="Enter"
                    Command="{Binding NewRequestCommand}" />
    </UserControl.Resources>
    <Border CornerRadius="8"
            ClipToBounds="True"
            Background="{DynamicResource MaterialDesign.Brush.Card.Background}"
            BorderThickness="1.5">
        <Border.Style>
            <Style TargetType="{x:Type Border}">
                <Setter Property="BorderBrush"
                        Value="{DynamicResource MaterialDesign.Brush.TextBox.Border}" />
                <Style.Triggers>
                    <DataTrigger Binding="{Binding ElementName=PromptTextBox,Path=IsFocused,Mode=OneWay}"
                                 Value="True">
                        <DataTrigger.Setters>
                            <Setter Property="BorderBrush"
                                    Value="{DynamicResource MaterialDesign.Brush.Primary.Light}" />
                        </DataTrigger.Setters>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>
        <StackPanel Orientation="Vertical">
            <TextBox x:Name="PromptTextBox"
                     Margin="8"
                     materialDesign:HintAssist.Hint="输入Prompt"
                     materialDesign:HintAssist.HintHorizontalAlignment="Left"
                     AcceptsReturn="True"
                     AcceptsTab="True"
                     VerticalAlignment="Stretch"
                     HorizontalAlignment="Stretch"
                     MinHeight="40"
                     Background="Transparent"
                     BorderThickness="0"
                     Text="{Binding  PromptString,Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}"
                     TextWrapping="Wrap"
                     VerticalScrollBarVisibility="Auto">
                <TextBox.Style>
                    <Style TargetType="TextBox"
                           BasedOn="{StaticResource MaterialDesignTextBoxBase}">
                        <Setter Property="materialDesign:TextFieldAssist.DecorationVisibility"
                                Value="Collapsed" />
                        <Setter Property="MaxHeight" Value="40" />
                        <Style.Triggers>
                            <Trigger Property="IsKeyboardFocusWithin" Value="True">
                                <Setter Property="MaxHeight" Value="500" />
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </TextBox.Style>
            </TextBox>
            <Border Background="{DynamicResource MaterialDesignTextFieldBoxBackground}"
                    Height="45">
                <Grid Margin="8,0"
                      VerticalAlignment="Center">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0"
                                Orientation="Horizontal">
                        <materialDesign:Card Padding="8,0"
                                             UniformCornerRadius="12"
                                             Height="32"
                                             Visibility="{Binding IsModelSupportFunctionCall,Mode=OneWay,Converter={StaticResource BooleanToVisibilityConverter}}"
                                             materialDesign:ElevationAssist.Elevation="Dp3">
                            <CheckBox materialDesign:CheckBoxAssist.CheckBoxSize="20"
                                      IsChecked="{Binding FunctionSelector.FunctionEnabled,Mode=TwoWay}">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Tools" />
                                    <materialDesign:PopupBox Margin="6,0"
                                                             StaysOpen="True"
                                                             PlacementMode="TopAndAlignLeftEdges"
                                                             Opened="McpPopupBox_OnOpened"
                                                             ToggleContent="{materialDesign:PackIcon Kind=Tools,Size=16}"
                                                             VerticalAlignment="Center"
                                                             ToolTip="Function Call工具"
                                                             PopupContent="{Binding FunctionSelector,Mode=OneWay}"
                                                             PopupContentTemplate="{StaticResource FunctionSelectorDataTemplate}"
                                                             Style="{StaticResource MaterialDesignToolPopupBox}" />
                                </StackPanel>
                            </CheckBox>
                        </materialDesign:Card>
                        <materialDesign:Card Padding="8,0"
                                             Margin="6,0,0,0"
                                             UniformCornerRadius="12"
                                             Height="32"
                                             Visibility="{Binding SearchConfig.IsSearchAvailable,Mode=OneWay,Converter={StaticResource BooleanToVisibilityConverter}}"
                                             materialDesign:ElevationAssist.Elevation="Dp3">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PopupBox StaysOpen="True"
                                                         PlacementMode="TopAndAlignLeftEdges"
                                                         ToggleContent="{materialDesign:PackIcon Kind=Web,Size=16}"
                                                         VerticalAlignment="Center"
                                                         ToolTip="Web Search工具"
                                                         PopupContent="{Binding SearchConfig,Mode=OneWay}"
                                                         Style="{StaticResource MaterialDesignToolPopupBox}">
                                    <materialDesign:PopupBox.PopupContentTemplate>
                                        <DataTemplate DataType="{x:Type mcp:SearchConfigViewModel}">
                                            <ListBox ItemsSource="{Binding SelectableSearchServices,Mode=OneWay}"
                                                     SelectedItem="{Binding SelectedSearchService,Mode=TwoWay}"
                                                     SelectionMode="Single">
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type abstraction:ISearchService}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Image Source="{Binding Icon.CurrentSource,Mode=OneWay}"
                                                                   Width="21"
                                                                   Height="21" />
                                                            <TextBlock Text="{Binding Name,Mode=OneTime}"
                                                                       VerticalAlignment="Center"
                                                                       Margin="6,0,0,0" />
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>
                                        </DataTemplate>
                                    </materialDesign:PopupBox.PopupContentTemplate>
                                </materialDesign:PopupBox>
                                <TextBlock Text="Search"
                                           Margin="6,0"
                                           VerticalAlignment="Center" />
                                <ToggleButton IsChecked="{Binding SearchConfig.SearchEnable,Mode=TwoWay}" />
                            </StackPanel>
                        </materialDesign:Card>
                        <materialDesign:Card Padding="8,0"
                                             Margin="6,0,0,0"
                                             UniformCornerRadius="12"
                                             Height="32"
                                             Visibility="{Binding ThinkingAvailable,Mode=OneWay,Converter={StaticResource BooleanToVisibilityConverter}}"
                                             materialDesign:ElevationAssist.Elevation="Dp3">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PopupBox StaysOpen="True"
                                                         PopupUniformCornerRadius="6"
                                                         PopupElevation="Dp3"
                                                         Padding="10"
                                                         PlacementMode="TopAndAlignLeftEdges"
                                                         ToggleContent="{materialDesign:PackIcon Kind=HeadThinkingOutline,Size=16}"
                                                         ToolTip="Thinking配置"
                                                         PopupContent="{Binding ThinkingConfig,Mode=OneTime}"
                                                         Style="{StaticResource MaterialDesignToolPopupBox}">
                                    <materialDesign:PopupBox.PopupContentTemplate>
                                        <DataTemplate DataType="{x:Type local:ThinkingConfigViewModel}">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition />
                                                </Grid.RowDefinitions>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition />
                                                </Grid.ColumnDefinitions>
                                                <ListBox Grid.Column="1"
                                                         ItemsSource="{Binding EffortLevels,Mode=OneTime}"
                                                         SelectedIndex="0"
                                                         SelectedItem="{Binding EffortLevel,Mode=TwoWay}"
                                                         SelectionMode="Single">
                                                    <ListBox.Style>
                                                        <Style TargetType="ListBox"
                                                               BasedOn="{StaticResource MaterialDesignToolToggleFlatListBox}">
                                                            <Setter Property="ItemContainerStyle">
                                                                <Setter.Value>
                                                                    <Style TargetType="ListBoxItem"
                                                                           BasedOn="{StaticResource MaterialDesignToolToggleListBoxItem}">
                                                                        <Setter Property="HorizontalContentAlignment"
                                                                            Value="Center" />
                                                                        <Setter Property="VerticalContentAlignment"
                                                                            Value="Center" />
                                                                        <Setter Property="MinWidth" Value="54" />
                                                                        <Setter Property="Height"
                                                                            Value="30" />
                                                                        <Setter Property="Padding" Value="6,3" />
                                                                        <Setter Property="TextBlock.FontSize"
                                                                            Value="16" />
                                                                        <Setter Property="TextBlock.FontWeight"
                                                                            Value="Black" />
                                                                    </Style>
                                                                </Setter.Value>
                                                            </Setter>
                                                        </Style>
                                                    </ListBox.Style>
                                                </ListBox>
                                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Effort Level:"
                                                           Margin="0,0,8,0"
                                                           Style="{StaticResource MaterialDesignSubtitle2TextBlock}"
                                                           VerticalAlignment="Center" />
                                                <CheckBox Grid.Row="1" Grid.Column="0"
                                                          Grid.ColumnSpan="2"
                                                          HorizontalAlignment="Left"
                                                          materialDesign:CheckBoxAssist.CheckBoxSize="26"
                                                          Margin="0,6,0,0"
                                                          IsChecked="{Binding EnableBudgetTokens,Mode=TwoWay}">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="Budget Tokens:"
                                                                   VerticalAlignment="Center"
                                                                   Style="{StaticResource MaterialDesignSubtitle2TextBlock}" />
                                                        <TextBox
                                                            Margin="6,0,0,0"
                                                            Padding="8,6"
                                                            Width="80"
                                                            Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                                            VerticalAlignment="Center">
                                                            <TextBox.Text>
                                                                <Binding Path="BudgetTokens" Mode="TwoWay">
                                                                    <Binding.ValidationRules>
                                                                        <component:TypeValidateRule
                                                                            TargetType="{x:Type sys:Int32}" />
                                                                    </Binding.ValidationRules>
                                                                </Binding>
                                                            </TextBox.Text>
                                                        </TextBox>
                                                    </StackPanel>
                                                </CheckBox>
                                                <CheckBox Grid.Row="2" Grid.Column="0"
                                                          Grid.ColumnSpan="2"
                                                          HorizontalAlignment="Left"
                                                          Margin="0,6,0,0"
                                                          FontSize="14"
                                                          Content="Show thinking details."
                                                          materialDesign:CheckBoxAssist.CheckBoxSize="26"
                                                          IsChecked="{Binding ShowThinking,Mode=TwoWay}" />
                                            </Grid>
                                        </DataTemplate>
                                    </materialDesign:PopupBox.PopupContentTemplate>
                                </materialDesign:PopupBox>
                                <TextBlock Text="Thinking"
                                           Margin="6,0"
                                           VerticalAlignment="Center" />
                                <ToggleButton IsChecked="{Binding ThinkingConfig.Enable,Mode=TwoWay}" />
                            </StackPanel>
                        </materialDesign:Card>
                    </StackPanel>
                    <DockPanel Grid.Column="1">
                        <Button Style="{StaticResource MaterialDesignFloatingActionMiniButton}"
                                Command="{Binding AddImageCommand}"
                                Height="32"
                                Width="32"
                                Margin="10,0,0,0"
                                Visibility="{Binding DefaultClient.Model.SupportImageInput,Mode=OneWay,Converter={StaticResource BooleanToVisibilityConverter}}">
                            <materialDesign:PackIcon Kind="FileImagePlusOutline"
                                                     Width="15"
                                                     Height="15" />
                        </Button>
                        <ScrollViewer VerticalScrollBarVisibility="Disabled"
                                      HorizontalScrollBarVisibility="Auto"
                                      DockPanel.Dock="Right"
                                      Margin="6,0">
                            <ItemsControl Padding="0"
                                          ItemsSource="{Binding Attachments,Mode=OneWay}"
                                          VerticalAlignment="Bottom">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal"
                                                    IsItemsHost="True" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="{x:Type local:Attachment}">
                                        <materialDesign:Chip IsDeletable="True"
                                                             MaxWidth="140"
                                                             Margin="0"
                                                             IconBackground="{DynamicResource MaterialDesign.Brush.Secondary.Light}"
                                                             IconForeground="{DynamicResource MaterialDesign.Brush.Secondary.Light.Foreground}"
                                                             ToolTipService.InitialShowDelay="0"
                                                             ToolTip="{Binding OriUri,Mode=OneTime}"
                                                             Command="{Binding OpenFileCommand}"
                                                             CommandParameter="{Binding}"
                                                             Content="{Binding Name,Mode=OneTime}"
                                                             DeleteCommand="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType=ItemsControl},Path=DataContext.RemoveAttachmentCommand}"
                                                             DeleteCommandParameter="{Binding  }">
                                            <materialDesign:Chip.Icon>
                                                <materialDesign:PackIcon
                                                    Kind="{Binding Type,Mode=OneWay,Converter={x:Static converters:AttachmentTypeConverter.Instance}}" />
                                            </materialDesign:Chip.Icon>
                                        </materialDesign:Chip>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </DockPanel>
                    <StackPanel Grid.Column="2"
                                Orientation="Horizontal"
                                Margin="0,4,0,0"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Bottom">
                        <CheckBox Content="回车发送"
                                  Margin="16,0,0,0"
                                  Checked="EnterKeyInputBinding_OnChecked"
                                  Unchecked="EnterKeyInputBinding_OnUnchecked"
                                  materialDesign:CheckBoxAssist.CheckBoxSize="30" />
                        <Button Command="{Binding NewRequestCommand}"
                                Width="80"
                                Height="30"
                                Margin="16,0,0,0"
                                Style="{StaticResource MaterialDesignRaisedDarkButton}"
                                Content="发送" />
                        <Button Command="{Binding ConclusionCommand}"
                                Margin="16,0,0,0"
                                Content="总结"
                                Style="{StaticResource MaterialDesignPaperLightButton}" />
                        <!--<Button Command="{Binding TestCommand}"
                        Content="测试" />-->
                    </StackPanel>
                </Grid>
            </Border>
        </StackPanel>
    </Border>
</UserControl>