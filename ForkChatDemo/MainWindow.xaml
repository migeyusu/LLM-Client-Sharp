<Window x:Class="ForkChatDemo.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:ForkChatDemo"
        xmlns:vm="clr-namespace:ForkChatDemo.ViewModels"
        xmlns:models="clr-namespace:ForkChatDemo.Models"
        xmlns:conv="clr-namespace:ForkChatDemo.Converters"
        Title="å¯¹è¯åˆ†å‰æ ‘ Demo" 
        Height="750" Width="1200"
        Background="#F5F5F5"
        WindowStartupLocation="CenterScreen">

    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <!-- è½¬æ¢å™¨ -->
        <conv:RoleToBackgroundConverter x:Key="RoleToBackground"/>
        <conv:RoleToBorderConverter x:Key="RoleToBorder"/>
        <conv:RoleToForegroundConverter x:Key="RoleToForeground"/>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <conv:ChildCountToVisibilityConverter x:Key="ChildCountToVisibility"/>

        <!-- è¿žçº¿ç”»ç¬” -->
        <SolidColorBrush x:Key="LineBrush" Color="#C0C0C0"/>
        <SolidColorBrush x:Key="LineActiveBrush" Color="#4A90D9"/>

        <!-- ============================================ -->
        <!-- TreeViewItem è‡ªå®šä¹‰æ ·å¼ï¼ˆæ ¸å¿ƒï¼šè¿žçº¿å®žçŽ°ï¼‰ -->
        <!-- ============================================ -->
        <Style x:Key="ChatTreeViewItemStyle" TargetType="TreeViewItem">
            <Setter Property="IsExpanded" Value="True"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TreeViewItem">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- ====== ç¬¬ä¸€è¡Œï¼šå½“å‰èŠ‚ç‚¹ ====== -->
                            <Grid Grid.Row="0" Margin="0,0,0,0">
                                <Grid.ColumnDefinitions>
                                    <!-- è¿žçº¿åŒºåŸŸ -->
                                    <ColumnDefinition Width="24"/>
                                    <!-- å†…å®¹åŒºåŸŸ -->
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- è¿žçº¿Canvas -->
                                <Canvas Grid.Column="0" 
                                        Width="24" 
                                        ClipToBounds="False"
                                        VerticalAlignment="Stretch">
                                    
                                    <!-- ç«–çº¿ï¼ˆä¸ŠåŠæ®µï¼šè¿žæŽ¥åˆ°çˆ¶èŠ‚ç‚¹ï¼‰ -->
                                    <Line X1="12" Y1="0" X2="12" Y2="20"
                                          Stroke="{StaticResource LineBrush}"
                                          StrokeThickness="2"
                                          Visibility="{Binding Parent, 
                                              Converter={StaticResource BoolToVisibility},
                                              ConverterParameter=NotNull}"/>
                                    
                                    <!-- æ¨ªçº¿ï¼ˆè¿žæŽ¥åˆ°èŠ‚ç‚¹ï¼‰ -->
                                    <Line X1="12" Y1="20" X2="24" Y2="20"
                                          Stroke="{StaticResource LineBrush}"
                                          StrokeThickness="2"
                                          Visibility="{Binding Parent, 
                                              Converter={StaticResource BoolToVisibility},
                                              ConverterParameter=NotNull}"/>
                                    
                                    <!-- èŠ‚ç‚¹åœ†ç‚¹ -->
                                    <Ellipse Canvas.Left="6" Canvas.Top="14" 
                                             Width="12" Height="12"
                                             Fill="{Binding Role, Converter={StaticResource RoleToBorder}}"
                                             Stroke="White" StrokeThickness="2"/>
                                </Canvas>

                                <!-- èŠ‚ç‚¹å†…å®¹å¡ç‰‡ -->
                                <Border Grid.Column="1"
                                        Margin="4,4,8,4"
                                        Padding="12,8"
                                        CornerRadius="8"
                                        Background="{Binding Role, Converter={StaticResource RoleToBackground}}"
                                        BorderBrush="{Binding Role, Converter={StaticResource RoleToBorder}}"
                                        BorderThickness="1.5"
                                        Cursor="Hand"
                                        MaxWidth="600"
                                        HorizontalAlignment="Left">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="6" 
                                                          ShadowDepth="1" 
                                                          Opacity="0.15" 
                                                          Color="Black"/>
                                    </Border.Effect>
                                    
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <!-- è§’è‰²æ ‡ç­¾ + åˆ†å‰æ ‡è®° -->
                                        <StackPanel Grid.Row="0" 
                                                    Orientation="Horizontal" 
                                                    Margin="0,0,0,4">
                                            <TextBlock Text="{Binding RoleLabel}"
                                                       FontWeight="SemiBold"
                                                       FontSize="12"
                                                       Foreground="{Binding Role, Converter={StaticResource RoleToForeground}}"/>
                                            
                                            <!-- åˆ†å‰æ ‡è®° -->
                                            <Border Margin="8,0,0,0"
                                                    Padding="6,2"
                                                    CornerRadius="4"
                                                    Background="#FFE4B5"
                                                    Visibility="{Binding Children.Count, 
                                                        Converter={StaticResource ChildCountToVisibility}}">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="â‘‚" FontSize="10" Margin="0,0,3,0"/>
                                                    <TextBlock FontSize="10" Foreground="#996600">
                                                        <Run Text="{Binding Children.Count, Mode=OneWay}"/>
                                                        <Run Text="æ¡åˆ†æ”¯"/>
                                                    </TextBlock>
                                                </StackPanel>
                                            </Border>
                                        </StackPanel>

                                        <!-- å†…å®¹æ–‡æœ¬ -->
                                        <TextBlock Grid.Row="1"
                                                   Text="{Binding DisplayText}"
                                                   TextWrapping="Wrap"
                                                   FontSize="13"
                                                   Foreground="#333"
                                                   MaxWidth="550"/>
                                    </Grid>
                                </Border>
                            </Grid>

                            <!-- ====== ç¬¬äºŒè¡Œï¼šå­èŠ‚ç‚¹å®¹å™¨ ====== -->
                            <Grid Grid.Row="1">
                                <Grid.ColumnDefinitions>
                                    <!-- è¿žçº¿å»¶ä¼¸åŒºåŸŸ -->
                                    <ColumnDefinition Width="24"/>
                                    <!-- å­èŠ‚ç‚¹åŒºåŸŸ -->
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- å»¶ä¼¸ç«–çº¿ï¼ˆä»…å½“æœ‰å­èŠ‚ç‚¹æ—¶æ˜¾ç¤ºï¼‰ -->
                                <Border Grid.Column="0" 
                                        Width="2" 
                                        HorizontalAlignment="Center"
                                        Background="{StaticResource LineBrush}"
                                        Visibility="{Binding HasItems, 
                                            RelativeSource={RelativeSource TemplatedParent},
                                            Converter={StaticResource BoolToVisibility}}"
                                        Margin="0,-4,0,0"/>

                                <!-- å­èŠ‚ç‚¹ItemsPresenter -->
                                <ItemsPresenter Grid.Column="1" Margin="0"/>
                            </Grid>
                        </Grid>

                        <!-- è§¦å‘å™¨ -->
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="Transparent"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>

            <!-- é€‰ä¸­çŠ¶æ€é«˜äº® -->
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="Transparent"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- å±‚çº§æ•°æ®æ¨¡æ¿ -->
        <HierarchicalDataTemplate x:Key="ChatNodeTemplate" 
                                  DataType="{x:Type models:ChatNode}"
                                  ItemsSource="{Binding Children}">
            <!-- å†…å®¹ç”± TreeViewItem æ¨¡æ¿å¤„ç† -->
        </HierarchicalDataTemplate>

    </Window.Resources>

    <!-- ============================================ -->
    <!-- ä¸»ç•Œé¢å¸ƒå±€ -->
    <!-- ============================================ -->
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*" MinWidth="400"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*" MinWidth="300"/>
        </Grid.ColumnDefinitions>

        <!-- å·¦ä¾§ï¼šå¯¹è¯æ ‘ -->
        <DockPanel Grid.Column="0" Margin="16">
            <!-- æ ‡é¢˜æ  -->
            <Border DockPanel.Dock="Top" 
                    Margin="0,0,0,12" 
                    Padding="12,8"
                    Background="White"
                    CornerRadius="8">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸŒ³" FontSize="20" Margin="0,0,8,0"/>
                    <TextBlock Text="å¯¹è¯åˆ†å‰æ ‘" 
                               FontSize="18" 
                               FontWeight="Bold" 
                               Foreground="#333"/>
                    <TextBlock Text="ï¼ˆç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹å®Œæ•´å¯¹è¯è·¯å¾„ï¼‰" 
                               FontSize="12" 
                               Foreground="#888"
                               VerticalAlignment="Center"
                               Margin="12,0,0,0"/>
                </StackPanel>
            </Border>

            <!-- æ ‘å½¢è§†å›¾ -->
            <Border Background="White" CornerRadius="8" Padding="8">
                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Auto">
                    <TreeView ItemsSource="{Binding RootNodes}"
                              ItemContainerStyle="{StaticResource ChatTreeViewItemStyle}"
                              ItemTemplate="{StaticResource ChatNodeTemplate}"
                              SelectedItemChanged="TreeView_SelectedItemChanged"
                              Background="Transparent"
                              BorderThickness="0"
                              Padding="8"
                              VirtualizingStackPanel.IsVirtualizing="True"
                              VirtualizingStackPanel.VirtualizationMode="Recycling">
                    </TreeView>
                </ScrollViewer>
            </Border>
        </DockPanel>

        <!-- åˆ†éš”æ¡ -->
        <GridSplitter Grid.Column="1" 
                      Width="6" 
                      HorizontalAlignment="Center"
                      VerticalAlignment="Stretch"
                      Background="#E0E0E0"
                      Margin="0,16"/>

        <!-- å³ä¾§ï¼šé€‰ä¸­è·¯å¾„é¢„è§ˆ -->
        <DockPanel Grid.Column="2" Margin="16">
            <!-- æ ‡é¢˜ -->
            <Border DockPanel.Dock="Top" 
                    Margin="0,0,0,12" 
                    Padding="12,8"
                    Background="White"
                    CornerRadius="8">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ“‹" FontSize="20" Margin="0,0,8,0"/>
                    <TextBlock Text="å®Œæ•´å¯¹è¯è·¯å¾„" 
                               FontSize="18" 
                               FontWeight="Bold" 
                               Foreground="#333"/>
                </StackPanel>
            </Border>

            <!-- è·¯å¾„å†…å®¹ -->
            <Border Background="White" CornerRadius="8" Padding="16">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <TextBlock Text="{Binding SelectedPath}"
                               TextWrapping="Wrap"
                               FontSize="13"
                               LineHeight="22"
                               Foreground="#444"/>
                </ScrollViewer>
            </Border>
        </DockPanel>
    </Grid>
</Window>