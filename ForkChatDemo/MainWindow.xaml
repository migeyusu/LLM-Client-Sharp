<Window x:Class="ForkChatDemo.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:ForkChatDemo"
        xmlns:vm="clr-namespace:ForkChatDemo.ViewModels"
        xmlns:models="clr-namespace:ForkChatDemo.Models"
        xmlns:conv="clr-namespace:ForkChatDemo.Converters"
        Title="å¯¹è¯åˆ†å‰æ ‘ Demo"
        Height="750" Width="1200"
        Background="#F5F5F5"
        WindowStartupLocation="CenterScreen">

    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Window.Resources>
        <!-- è½¬æ¢å™¨ -->
        <conv:RoleToBackgroundConverter x:Key="RoleToBackground" />
        <conv:RoleToBorderConverter x:Key="RoleToBorder" />
        <conv:RoleToForegroundConverter x:Key="RoleToForeground" />
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibility" />
        <conv:ChildCountToVisibilityConverter x:Key="ChildCountToVisibility" />
        <conv:SiblingIndexToBrushConverter x:Key="SiblingIndexToBrush"/>
        <!-- è¿žçº¿ç”»ç¬” -->
        <SolidColorBrush x:Key="LineBrush" Color="#C0C0C0" />
        <SolidColorBrush x:Key="LineActiveBrush" Color="#4A90D9" />
        <!-- åˆ†å‰å­èŠ‚ç‚¹æ ‡è®°æ ·å¼ï¼ˆå¯é€‰ï¼‰ -->
        <Style x:Key="BranchIndicator" TargetType="Border">
            <Setter Property="Width" Value="4" />
            <Setter Property="Height" Value="4" />
            <Setter Property="CornerRadius" Value="2" />
            <Setter Property="Margin" Value="0,8,4,0" />
        </Style>

        <!-- åˆ†æ”¯é¢œè‰²å®šä¹‰ -->
        <SolidColorBrush x:Key="Branch0Color" Color="#4A90D9" />
        <SolidColorBrush x:Key="Branch1Color" Color="#66BB6A" />
        <SolidColorBrush x:Key="Branch2Color" Color="#FFA726" />
        <Style x:Key="ChatTreeViewItemStyle" TargetType="TreeViewItem">
            <Setter Property="IsExpanded" Value="True" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TreeViewItem">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <!-- ====== ç¬¬ä¸€è¡Œï¼šå½“å‰èŠ‚ç‚¹ ====== -->
                            <Grid Grid.Row="0" Margin="0,0,0,0">
                                <Grid.ColumnDefinitions>
                                    <!-- è¿žçº¿åŒºåŸŸï¼ˆæ‰©å¤§ä»¥å®¹çº³åˆ†å‰ï¼‰ -->
                                    <ColumnDefinition Width="48" />
                                    <!-- å†…å®¹åŒºåŸŸ -->
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <!-- è¿žçº¿Canvas -->
                                <Canvas Grid.Column="0"
                                        Width="48"
                                        ClipToBounds="False"
                                        VerticalAlignment="Stretch"
                                        MinHeight="40">

                                    <!-- ä¸Šæ–¹å»¶ä¼¸ç«–çº¿ï¼ˆè¿žæŽ¥åˆ°çˆ¶èŠ‚ç‚¹ï¼‰ -->
                                    <Line x:Name="LineToParent"
                                          X1="24" Y1="0" X2="24" Y2="20"
                                          Stroke="{StaticResource LineBrush}"
                                          StrokeThickness="2.5"
                                          StrokeDashArray="0"
                                          Visibility="Collapsed" />

                                    <!-- å…¥å£è¿žæŽ¥çº¿ï¼ˆè´å¡žå°”æ›²çº¿ï¼‰ -->
                                    <Path x:Name="BezierToParent"
                                          Stroke="{StaticResource LineBrush}"
                                          StrokeThickness="2.5"
                                          Visibility="Collapsed">
                                        <Path.Data>
                                            <PathGeometry>
                                                <PathFigure StartPoint="8,0">
                                                    <BezierSegment Point1="8,10" Point2="24,10" Point3="24,20" />
                                                </PathFigure>
                                            </PathGeometry>
                                        </Path.Data>
                                    </Path>

                                    <!-- èŠ‚ç‚¹åœ†ç‚¹ï¼ˆæ™®é€šèŠ‚ç‚¹ï¼‰ -->
                                    <Ellipse x:Name="NodeDot"
                                             Canvas.Left="18" Canvas.Top="14"
                                             Width="12" Height="12"
                                             Fill="{Binding Role, Converter={StaticResource RoleToBorder}}"
                                             Stroke="White"
                                             StrokeThickness="2.5" />

                                    <!-- åˆ†å‰èŠ‚ç‚¹ç‰¹æ®Šæ ‡è®° -->
                                    <Grid x:Name="ForkMarker"
                                          Canvas.Left="12" Canvas.Top="8"
                                          Width="24" Height="24"
                                          Visibility="Collapsed">
                                        <Ellipse Fill="White"
                                                 Stroke="#FF9500"
                                                 StrokeThickness="3" />
                                        <Path Data="M8,12 L12,16 L16,12 M12,8 L12,16"
                                              Stroke="#FF9500"
                                              StrokeThickness="2.5"
                                              StrokeStartLineCap="Round"
                                              StrokeEndLineCap="Round"
                                              StrokeLineJoin="Round" />
                                    </Grid>
                                </Canvas>

                                <!-- èŠ‚ç‚¹å†…å®¹å¡ç‰‡ -->
                                <Border Grid.Column="1"
                                        Margin="4,4,8,4"
                                        Padding="12,8"
                                        CornerRadius="8"
                                        Background="{Binding Role, Converter={StaticResource RoleToBackground}}"
                                        BorderBrush="{Binding Role, Converter={StaticResource RoleToBorder}}"
                                        BorderThickness="1.5"
                                        Cursor="Hand"
                                        MaxWidth="600"
                                        HorizontalAlignment="Left">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="8"
                                                          ShadowDepth="2"
                                                          Opacity="0.2"
                                                          Color="Black" />
                                    </Border.Effect>

                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <!-- è§’è‰²æ ‡ç­¾ + åˆ†å‰æ ‡è®° -->
                                        <StackPanel Grid.Row="0"
                                                    Orientation="Horizontal"
                                                    Margin="0,0,0,4">
                                            <TextBlock Text="{Binding RoleLabel}"
                                                       FontWeight="SemiBold"
                                                       FontSize="12"
                                                       Foreground="{Binding Role, Converter={StaticResource RoleToForeground}}" />

                                            <!-- åˆ†å‰æ ‡è®° -->
                                            <Border Margin="8,0,0,0"
                                                    Padding="6,2"
                                                    CornerRadius="10"
                                                    Background="#FFF3E0"
                                                    BorderBrush="#FF9500"
                                                    BorderThickness="1"
                                                    Visibility="{Binding Children.Count, 
                                                Converter={StaticResource ChildCountToVisibility}}">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="â‘‚" FontSize="11" Margin="0,0,4,0"
                                                               Foreground="#FF6F00" />
                                                    <TextBlock FontSize="10"
                                                               FontWeight="SemiBold"
                                                               Foreground="#FF6F00">
                                                        <Run Text="{Binding Children.Count, Mode=OneWay}" />
                                                        <Run Text="ä¸ªåˆ†æ”¯" />
                                                    </TextBlock>
                                                </StackPanel>
                                            </Border>
                                        </StackPanel>

                                        <!-- å†…å®¹æ–‡æœ¬ -->
                                        <TextBlock Grid.Row="1"
                                                   Text="{Binding DisplayText}"
                                                   TextWrapping="Wrap"
                                                   FontSize="13"
                                                   Foreground="#333"
                                                   MaxWidth="550" />
                                    </Grid>
                                </Border>
                            </Grid>

                            <!-- ====== ç¬¬äºŒè¡Œï¼šå­èŠ‚ç‚¹å®¹å™¨ ====== -->
                            <Grid Grid.Row="1" x:Name="ChildrenPanel">
                                <Grid.ColumnDefinitions>
                                    <!-- è¿žçº¿å»¶ä¼¸åŒºåŸŸ -->
                                    <ColumnDefinition Width="48" />
                                    <!-- å­èŠ‚ç‚¹åŒºåŸŸ -->
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <!-- åˆ†å‰çº¿å®¹å™¨ -->
                                <Canvas Grid.Column="0"
                                        x:Name="ForkCanvas"
                                        ClipToBounds="False"
                                        Background="Transparent">
                                    <!-- åˆ†å‰çº¿å°†ç”±è§¦å‘å™¨åŠ¨æ€ç”Ÿæˆ -->
                                </Canvas>

                                <!-- å­èŠ‚ç‚¹ItemsPresenter -->
                                <ItemsPresenter Grid.Column="1"
                                                x:Name="ItemsPresenter"
                                                Margin="0" />
                            </Grid>
                        </Grid>

                        <!-- ============================================ -->
                        <!-- è§¦å‘å™¨ï¼šæ ¹æ®å±‚çº§å’Œå…„å¼Ÿå…³ç³»æ˜¾ç¤ºä¸åŒè¿žçº¿ -->
                        <!-- ============================================ -->
                        <ControlTemplate.Triggers>
                            <!-- æœ‰çˆ¶èŠ‚ç‚¹ä¸”ä¸æ˜¯åˆ†å‰å­èŠ‚ç‚¹ -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding Parent, Converter={StaticResource BoolToVisibility}}"
                                               Value="Visible" />
                                    <Condition Binding="{Binding HasSiblings}" Value="False" />
                                </MultiDataTrigger.Conditions>
                                <Setter TargetName="LineToParent" Property="Visibility" Value="Visible" />
                            </MultiDataTrigger>

                            <!-- æœ‰çˆ¶èŠ‚ç‚¹ä¸”æ˜¯åˆ†å‰å­èŠ‚ç‚¹ -->
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding Parent, Converter={StaticResource BoolToVisibility}}"
                                               Value="Visible" />
                                    <Condition Binding="{Binding HasSiblings}" Value="True" />
                                </MultiDataTrigger.Conditions>
                                <Setter TargetName="BezierToParent" Property="Visibility" Value="Visible" />
                                <Setter TargetName="LineToParent" Property="Visibility" Value="Collapsed" />
                            </MultiDataTrigger>

                            <!-- æœ‰å¤šä¸ªå­èŠ‚ç‚¹æ—¶æ˜¾ç¤ºåˆ†å‰æ ‡è®° -->
                            <DataTrigger
                                Binding="{Binding Children.Count, 
                                    Converter={StaticResource ChildCountToVisibility}}"
                                Value="Visible">
                                <Setter TargetName="ForkMarker" Property="Visibility" Value="Visible" />
                                <Setter TargetName="NodeDot" Property="Visibility" Value="Collapsed" />
                            </DataTrigger>

                            <!-- æ ¹æ®å…„å¼Ÿç´¢å¼•è°ƒæ•´è´å¡žå°”æ›²çº¿èµ·ç‚¹ -->
                            <DataTrigger Binding="{Binding SiblingIndex}" Value="0">
                                <Setter TargetName="BezierToParent" Property="Data">
                                    <Setter.Value>
                                        <PathGeometry>
                                            <PathFigure StartPoint="8,0">
                                                <BezierSegment Point1="8,12" Point2="20,12" Point3="24,20" />
                                            </PathFigure>
                                        </PathGeometry>
                                    </Setter.Value>
                                </Setter>
                                <Setter TargetName="BezierToParent" Property="Stroke" Value="#4A90D9" />
                            </DataTrigger>

                            <DataTrigger Binding="{Binding SiblingIndex}" Value="1">
                                <Setter TargetName="BezierToParent" Property="Data">
                                    <Setter.Value>
                                        <PathGeometry>
                                            <PathFigure StartPoint="24,0">
                                                <BezierSegment Point1="24,10" Point2="24,10" Point3="24,20" />
                                            </PathFigure>
                                        </PathGeometry>
                                    </Setter.Value>
                                </Setter>
                                <Setter TargetName="BezierToParent" Property="Stroke" Value="#66BB6A" />
                            </DataTrigger>

                            <DataTrigger Binding="{Binding SiblingIndex}" Value="2">
                                <Setter TargetName="BezierToParent" Property="Data">
                                    <Setter.Value>
                                        <PathGeometry>
                                            <PathFigure StartPoint="40,0">
                                                <BezierSegment Point1="40,12" Point2="28,12" Point3="24,20" />
                                            </PathFigure>
                                        </PathGeometry>
                                    </Setter.Value>
                                </Setter>
                                <Setter TargetName="BezierToParent" Property="Stroke" Value="#FFA726" />
                            </DataTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- å±‚çº§æ•°æ®æ¨¡æ¿ -->
        <HierarchicalDataTemplate x:Key="ChatNodeTemplate"
                                  DataType="{x:Type models:ChatNode}"
                                  ItemsSource="{Binding Children}">
            <!-- å†…å®¹ç”± TreeViewItem æ¨¡æ¿å¤„ç† -->
        </HierarchicalDataTemplate>

    </Window.Resources>

    <!-- ============================================ -->
    <!-- ä¸»ç•Œé¢å¸ƒå±€ -->
    <!-- ============================================ -->
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*" MinWidth="400" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" MinWidth="300" />
        </Grid.ColumnDefinitions>

        <!-- å·¦ä¾§ï¼šå¯¹è¯æ ‘ -->
        <DockPanel Grid.Column="0" Margin="16">
            <!-- æ ‡é¢˜æ  -->
            <Border DockPanel.Dock="Top"
                    Margin="0,0,0,12"
                    Padding="12,8"
                    Background="White"
                    CornerRadius="8">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸŒ³" FontSize="20" Margin="0,0,8,0" />
                    <TextBlock Text="å¯¹è¯åˆ†å‰æ ‘"
                               FontSize="18"
                               FontWeight="Bold"
                               Foreground="#333" />
                    <TextBlock Text="ï¼ˆç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹å®Œæ•´å¯¹è¯è·¯å¾„ï¼‰"
                               FontSize="12"
                               Foreground="#888"
                               VerticalAlignment="Center"
                               Margin="12,0,0,0" />
                </StackPanel>
            </Border>

            <!-- æ ‘å½¢è§†å›¾ -->
            <Border Background="White" CornerRadius="8" Padding="8">
                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Auto">
                    <TreeView ItemsSource="{Binding RootNodes}"
                              ItemContainerStyle="{StaticResource ChatTreeViewItemStyle}"
                              ItemTemplate="{StaticResource ChatNodeTemplate}"
                              SelectedItemChanged="TreeView_SelectedItemChanged"
                              Background="Transparent"
                              BorderThickness="0"
                              Padding="8"
                              VirtualizingStackPanel.IsVirtualizing="True"
                              VirtualizingStackPanel.VirtualizationMode="Recycling">
                    </TreeView>
                </ScrollViewer>
            </Border>
        </DockPanel>

        <!-- åˆ†éš”æ¡ -->
        <GridSplitter Grid.Column="1"
                      Width="6"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Stretch"
                      Background="#E0E0E0"
                      Margin="0,16" />

        <!-- å³ä¾§ï¼šé€‰ä¸­è·¯å¾„é¢„è§ˆ -->
        <DockPanel Grid.Column="2" Margin="16">
            <!-- æ ‡é¢˜ -->
            <Border DockPanel.Dock="Top"
                    Margin="0,0,0,12"
                    Padding="12,8"
                    Background="White"
                    CornerRadius="8">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ“‹" FontSize="20" Margin="0,0,8,0" />
                    <TextBlock Text="å®Œæ•´å¯¹è¯è·¯å¾„"
                               FontSize="18"
                               FontWeight="Bold"
                               Foreground="#333" />
                </StackPanel>
            </Border>

            <!-- è·¯å¾„å†…å®¹ -->
            <Border Background="White" CornerRadius="8" Padding="16">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <TextBlock Text="{Binding SelectedPath}"
                               TextWrapping="Wrap"
                               FontSize="13"
                               LineHeight="22"
                               Foreground="#444" />
                </ScrollViewer>
            </Border>
        </DockPanel>
    </Grid>
</Window>